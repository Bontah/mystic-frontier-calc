function Xt(){return{calcFamiliars:[null,null,null],currentWave:null,savedWaves:{1:[null,null,null],2:[null,null,null],3:[null,null,null]},bonusItems:[],characters:[],currentCharacterId:null,editingFamiliarId:null,modalSelectedConditional:null,modalSelectedTrigger:null,modalTriggerVariants:[],rosterSelectedConditional:null,rosterSelectedTrigger:null,rosterTriggerVariants:[],configBonusItems:{version:"1.0",description:"",items:[]},configConditionalBonuses:{bonuses:[]},configOptimizer:{version:"1.0",strategies:{overall:{enabled:!0,ignoredConditionalIds:[]},lowRolls:{enabled:!0,ignoredConditionalIds:[]},highRolls:{enabled:!0,ignoredConditionalIds:[]},median:{enabled:!0,ignoredConditionalIds:[]},floorGuarantee:{enabled:!0,ignoredConditionalIds:[]},balanced:{enabled:!0,ignoredConditionalIds:[]},diceIndependent:{enabled:!0,ignoredConditionalIds:[]}}},optimizerRunning:!1,optimizerProgress:0}}var rt=class{state;listeners=new Set;constructor(t){this.state=t}getState(){return this.state}setState(t){let n=typeof t=="function"?t(this.state):t;this.state={...this.state,...n},this.notify()}select(t){return t(this.state)}subscribe(t){return this.listeners.add(t),()=>this.listeners.delete(t)}notify(){this.listeners.forEach(t=>t(this.state))}reset(){let t={configBonusItems:this.state.configBonusItems,configConditionalBonuses:this.state.configConditionalBonuses,configOptimizer:this.state.configOptimizer};this.state={...Xt(),...t},this.notify()}},h=new rt(Xt()),R={getCurrentCharacter:e=>e.characters.find(t=>t.id===e.currentCharacterId),getCurrentRoster:e=>e.characters.find(n=>n.id===e.currentCharacterId)?.roster??[],getActiveCalcFamiliars:e=>e.calcFamiliars.filter(t=>t!==null),getWaveFamiliars:(e,t)=>R.getCurrentRoster(e).filter(o=>o.wave===t&&!o.disabled)};var P={BONUS_ITEMS:"bonusItems",CHARACTERS:"characters",CURRENT_CHARACTER_ID:"currentCharacterId",SAVED_WAVES:"savedWaves",FAMILIAR_ROSTER:"familiarRoster",CONDITIONAL_BONUSES_LEGACY:"conditionalBonuses"};function st(){try{let e="__storage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch{return!1}}function Ie(e,t){if(!st())return t;try{let n=localStorage.getItem(e);return n===null?t:JSON.parse(n)}catch{return t}}function Ae(e,t){if(st())try{localStorage.setItem(e,JSON.stringify(t))}catch{console.warn(`Failed to save ${e} to localStorage`)}}function no(e){if(e.length>0)return e;let t=Ie(P.FAMILIAR_ROSTER,[]);if(t.length>0){try{localStorage.removeItem(P.FAMILIAR_ROSTER)}catch{}return[{id:Date.now(),name:"Main",roster:t}]}return e}function oo(e){if(e.length===0){let t={id:Date.now(),name:"Main",roster:[]};return{characters:[t],currentId:t.id}}return{characters:e,currentId:e[0].id}}var ao={1:[null,null,null],2:[null,null,null],3:[null,null,null]};function io(){if(st())try{localStorage.removeItem(P.CONDITIONAL_BONUSES_LEGACY)}catch{}}function ro(){let e=new URLSearchParams(window.location.search).has("is_dev");io(),e&&(console.group("[persistence] Loading from localStorage"),console.log("Raw savedWaves from localStorage:",localStorage.getItem(P.SAVED_WAVES)),console.log("Raw characters from localStorage:",localStorage.getItem(P.CHARACTERS)));let t=Ie(P.BONUS_ITEMS,[]),n=Ie(P.SAVED_WAVES,ao);e&&console.log("Parsed savedWaves:",n);let o=Ie(P.CHARACTERS,[]),a=Ie(P.CURRENT_CHARACTER_ID,null);e&&console.log("Parsed characters:",o),o=no(o);let i=oo(o);return o=i.characters,(!a||!o.find(r=>r.id===a))&&(a=i.currentId),e&&(console.log("Final loaded state:",{bonusItems:t,savedWaves:n,characters:o,currentCharacterId:a}),console.groupEnd()),{bonusItems:t,savedWaves:n,characters:o,currentCharacterId:a}}function k(){let e=h.getState();Ae(P.BONUS_ITEMS,e.bonusItems),Ae(P.SAVED_WAVES,e.savedWaves),Ae(P.CHARACTERS,e.characters),Ae(P.CURRENT_CHARACTER_ID,e.currentCharacterId)}function Qt(){let e=new URLSearchParams(window.location.search).has("is_dev"),t=ro();e&&console.log("[persistence] Setting persisted state to store:",t),h.setState(t),e&&console.log("[persistence] Store state after init:",h.getState())}function en(){return h.subscribe(()=>{k()})}var lt={BONUS_ITEMS:"config/bonus-items.json",CONDITIONAL_BONUSES:"config/conditional-bonuses.json",OPTIMIZER:"config/optimizer-config.json"};async function ct(e){let t=await fetch(e);if(!t.ok)throw new Error(`Failed to load ${e}: ${t.statusText}`);return t.json()}async function so(){try{return await ct(lt.BONUS_ITEMS)}catch(e){return console.error("Failed to load bonus items config:",e),{version:"1.0",description:"",items:[]}}}async function lo(){try{let e=await ct(lt.CONDITIONAL_BONUSES),t=[];for(let[n,o]of Object.entries(e.categories||{}))for(let a of o.bonuses||[])t.push({...a,rarity:n,color:o.color});return{version:e.version,bonuses:t}}catch(e){return console.error("Failed to load conditional bonuses config:",e),{bonuses:[]}}}var co={version:"1.0",strategies:{overall:{enabled:!0,ignoredConditionalIds:[]},lowRolls:{enabled:!0,ignoredConditionalIds:[]},highRolls:{enabled:!0,ignoredConditionalIds:[]},median:{enabled:!0,ignoredConditionalIds:[]},floorGuarantee:{enabled:!0,ignoredConditionalIds:[]},balanced:{enabled:!0,ignoredConditionalIds:[]},diceIndependent:{enabled:!0,ignoredConditionalIds:[]}}};async function uo(){try{return await ct(lt.OPTIMIZER)}catch(e){return console.error("Failed to load optimizer config:",e),co}}async function tn(){let[e,t,n]=await Promise.all([so(),lo(),uo()]);h.setState({configBonusItems:e,configConditionalBonuses:t,configOptimizer:n})}var $={borderColors:{Common:{r:127,g:127,b:127},Rare:{r:0,g:150,b:255},Epic:{r:110,g:75,b:255},Unique:{r:205,g:97,b:9},Legendary:{r:80,g:163,b:2}},elementIconRegion:{x:.89,y:.185,w:.065,h:.06},typeIconRegion:{x:.895,y:.27,w:.063,h:.06},nameRegion:{x:.05,y:.05,w:.75,h:.05},textRegion:{x:.03,y:.79,w:.94,h:.1},debug:!1},ce={r:58,g:52,b:47},nn=40,on=50,J={backgroundTolerance:45,morphologyKernel:0,useAdaptiveBackground:!0,weights:{mask:.8,hu:0,edge:.2,color:0}};function dt(e,t){return Math.sqrt(Math.pow(e.r-t.r,2)+Math.pow(e.g-t.g,2)+Math.pow(e.b-t.b,2))}function De(e){return new Promise((t,n)=>{let o=new Image;o.onload=()=>t(o),o.onerror=()=>n(new Error(`Failed to load ${e}`)),o.src=e})}function Fe(e,t,n){let o=$.borderColors;for(let[a,i]of Object.entries(o))if(dt({r:e,g:t,b:n},i)<on)return{match:!0,rank:a,color:i};return{match:!1}}function an(e,t){let o=t.getImageData(0,0,e.width,e.height).data,a=e.width,i=e.height,r=0,s=a,l=0,c=i,u=null;e:for(let v=0;v<a/2;v++)for(let I=Math.floor(i*.3);I<i*.7;I++){let C=(I*a+v)*4,E=Fe(o[C],o[C+1],o[C+2]);if(E.match){r=v,u=E.color;break e}}e:for(let v=a-1;v>a/2;v--)for(let I=Math.floor(i*.3);I<i*.7;I++){let C=(I*a+v)*4;if(Fe(o[C],o[C+1],o[C+2]).match){s=v+1;break e}}e:for(let v=0;v<i/2;v++)for(let I=Math.floor(a*.3);I<a*.7;I++){let C=(v*a+I)*4;if(Fe(o[C],o[C+1],o[C+2]).match){l=v;break e}}e:for(let v=i-1;v>i/2;v--)for(let I=Math.floor(a*.3);I<a*.7;I++){let C=(v*a+I)*4;if(Fe(o[C],o[C+1],o[C+2]).match){c=v+1;break e}}let d=u??{r:128,g:128,b:128},f={left:r,right:s,top:l,bottom:c},g=f.right-f.left,p=f.bottom-f.top,m=document.createElement("canvas");m.width=g,m.height=p;let y=m.getContext("2d");return y.drawImage(e,f.left,f.top,g,p,0,0,g,p),{borderColor:d,canvas:m,ctx:y,width:g,height:p,croppedImageUrl:m.toDataURL("image/png"),bounds:f}}function ut(e,t){let n=Math.floor(e.width*t.x),o=Math.floor(e.height*t.y),a=Math.floor(e.width*t.w),i=Math.floor(e.height*t.h),r=document.createElement("canvas");r.width=a,r.height=i;let s=r.getContext("2d");return s.drawImage(e.canvas,n,o,a,i,0,0,a,i),{canvas:r,ctx:s,width:a,height:i}}function mt(e,t,n){let o=e.getImageData(0,0,t,n),a=o.data,i=new Array(256).fill(0);for(let f=0;f<a.length;f+=4){let g=Math.round(a[f]*.299+a[f+1]*.587+a[f+2]*.114);i[g]++}let r=t*n,s=0;for(let f=0;f<256;f++)s+=f*i[f];let l=0,c=0,u=0,d=128;for(let f=0;f<256;f++){if(c+=i[f],c===0)continue;let g=r-c;if(g===0)break;l+=f*i[f];let p=l/c,m=(s-l)/g,y=c*g*(p-m)*(p-m);y>u&&(u=y,d=f)}for(let f=0;f<a.length;f+=4){let g=a[f]*.299+a[f+1]*.587+a[f+2]*.114,p=d<128?g>d?0:255:g>d?255:0;a[f]=p,a[f+1]=p,a[f+2]=p}e.putImageData(o,0,0)}function ft(e){let t=$.borderColors,n={rank:"Common",confidence:0,distance:1/0};for(let[o,a]of Object.entries(t)){let i=dt(e,a);if(i<n.distance){let r=Math.max(0,100-i/4.41);n={rank:o,confidence:Math.round(r),distance:i}}}return n}var b=32,de=null,gt=null,Ne={};function mo(e,t,n){return Math.sqrt(Math.pow(e-ce.r,2)+Math.pow(t-ce.g,2)+Math.pow(n-ce.b,2))<nn}function fo(e,t){let n=document.createElement("canvas");n.width=b,n.height=b;let o=n.getContext("2d");o.drawImage(e.canvas,0,0,b,b);let a=o.getImageData(0,0,b,b),i=document.createElement("canvas");i.width=b,i.height=b;let r=i.getContext("2d");r.drawImage(t,0,0,b,b);let s=r.getImageData(0,0,b,b),l=8,c=256/l,u={r:new Array(l).fill(0),g:new Array(l).fill(0),b:new Array(l).fill(0)},d={r:new Array(l).fill(0),g:new Array(l).fill(0),b:new Array(l).fill(0)},f=0,g=0;for(let m=0;m<a.data.length;m+=4){let y=a.data[m],v=a.data[m+1],I=a.data[m+2],C=a.data[m+3],E=s.data[m],D=s.data[m+1],B=s.data[m+2],M=s.data[m+3];C<128||(mo(y,v,I)||(u.r[Math.floor(y/c)]++,u.g[Math.floor(v/c)]++,u.b[Math.floor(I/c)]++,f++),M>=128&&(d.r[Math.floor(E/c)]++,d.g[Math.floor(D/c)]++,d.b[Math.floor(B/c)]++,g++))}if(f===0||g===0)return 0;let p=0;for(let m=0;m<l;m++)u.r[m]/=f,u.g[m]/=f,u.b[m]/=f,d.r[m]/=g,d.g[m]/=g,d.b[m]/=g,p+=Math.min(u.r[m],d.r[m]),p+=Math.min(u.g[m],d.g[m]),p+=Math.min(u.b[m],d.b[m]);return p/3*100}function go(e,t,n){let o=[],i=[[0,0],[1,0],[0,1],[1,1],[t-2,0],[t-1,0],[t-2,1],[t-1,1],[0,n-2],[1,n-2],[0,n-1],[1,n-1],[t-2,n-2],[t-1,n-2],[t-2,n-1],[t-1,n-1]];for(let[s,l]of i)if(s>=0&&s<t&&l>=0&&l<n){let c=(l*t+s)*4;o.push({r:e.data[c],g:e.data[c+1],b:e.data[c+2]})}if(o.length===0)return ce;let r=o.reduce((s,l)=>({r:s.r+l.r,g:s.g+l.g,b:s.b+l.b}),{r:0,g:0,b:0});return{r:Math.round(r.r/o.length),g:Math.round(r.g/o.length),b:Math.round(r.b/o.length)}}function po(e,t){return Math.sqrt(Math.pow(e.r-t.r,2)+Math.pow(e.g-t.g,2)+Math.pow(e.b-t.b,2))}function ho(e,t,n,o){let a=new Uint8Array(t*n),i=o;for(let r=0;r<n;r++)for(let s=0;s<t;s++){let l=!0;for(let c=-i;c<=i&&l;c++)for(let u=-i;u<=i&&l;u++){let d=s+u,f=r+c;(d<0||d>=t||f<0||f>=n||e[f*t+d]===0)&&(l=!1)}a[r*t+s]=l?1:0}return a}function vo(e,t,n,o){let a=new Uint8Array(t*n),i=o;for(let r=0;r<n;r++)for(let s=0;s<t;s++){let l=!1;for(let c=-i;c<=i&&!l;c++)for(let u=-i;u<=i&&!l;u++){let d=s+u,f=r+c;d>=0&&d<t&&f>=0&&f<n&&e[f*t+d]===1&&(l=!0)}a[r*t+s]=l?1:0}return a}function He(e,t,n,o={}){let a={backgroundTolerance:o.backgroundTolerance??J.backgroundTolerance,useAdaptiveBackground:o.useAdaptiveBackground??J.useAdaptiveBackground,morphologyKernel:o.morphologyKernel??J.morphologyKernel,alphaThreshold:o.alphaThreshold??128},i=a.useAdaptiveBackground?go(e,t,n):ce,r=new Uint8Array(t*n);for(let s=0;s<t*n;s++){let l=s*4,c=e.data[l],u=e.data[l+1],d=e.data[l+2],f=e.data[l+3],g=po({r:c,g:u,b:d},i);r[s]=f>a.alphaThreshold&&g>a.backgroundTolerance?1:0}if(a.morphologyKernel>0){let s=ho(r,t,n,a.morphologyKernel);return vo(s,t,n,a.morphologyKernel)}return r}function pt(e,t,n){let o=new Float32Array(t*n);for(let s=0;s<t*n;s++){let l=s*4;o[s]=e.data[l]*.299+e.data[l+1]*.587+e.data[l+2]*.114}let a=[-1,0,1,-2,0,2,-1,0,1],i=[-1,-2,-1,0,0,0,1,2,1],r=new Uint8Array(t*n);for(let s=1;s<n-1;s++)for(let l=1;l<t-1;l++){let c=0,u=0,d=0;for(let g=-1;g<=1;g++)for(let p=-1;p<=1;p++){let m=o[(s+g)*t+(l+p)];c+=m*a[d],u+=m*i[d],d++}let f=Math.sqrt(c*c+u*u);r[s*t+l]=f>50?1:0}return r}function yo(e,t){let n=0,o=0,a=0;for(let i=0;i<e.length;i++)e[i]&&t[i]&&n++,o+=e[i],a+=t[i];return o+a>0?2*n/(o+a)*100:0}function bo(e,t,n){e/=255,t/=255,n/=255;let o=Math.max(e,t,n),a=Math.min(e,t,n),i=0,r=0,s=(o+a)/2;if(o!==a){let l=o-a;switch(r=s>.5?l/(2-o-a):l/(o+a),o){case e:i=((t-n)/l+(t<n?6:0))/6;break;case t:i=((n-e)/l+2)/6;break;case n:i=((e-t)/l+4)/6;break}}return{h:i*360,s:r*100,l:s*100}}function rn(e,t,n,o){let a=[];for(let l=0;l<n*o;l++){if(t[l]===0)continue;let c=l*4,u=bo(e.data[c],e.data[c+1],e.data[c+2]);a.push(u)}if(a.length===0)return null;let i=a.reduce((l,c)=>l+c.h,0)/a.length,r=a.reduce((l,c)=>l+c.s,0)/a.length,s=a.reduce((l,c)=>l+c.l,0)/a.length;return{h:i,s:r,l:s}}function Io(e,t){if(!e||!t)return 0;let n=Math.abs(e.h-t.h);n>180&&(n=360-n),n/=180;let o=Math.abs(e.s-t.s)/100,a=Math.abs(e.l-t.l)/100,i=n*.5+o*.3+a*.2;return Math.max(0,(1-i)*100)}function ln(e,t,n={}){let o={mask:n.maskWeight??J.weights.mask,hu:n.huWeight??J.weights.hu,edge:n.edgeWeight??J.weights.edge,color:n.colorWeight??J.weights.color},a=n.maskOptions??{},i=document.createElement("canvas");i.width=b,i.height=b;let r=i.getContext("2d");r.drawImage(e.canvas,0,0,b,b);let s=r.getImageData(0,0,b,b),l=document.createElement("canvas");l.width=b,l.height=b;let c=l.getContext("2d");c.drawImage(t,0,0,b,b);let u=c.getImageData(0,0,b,b),d=He(s,b,b,a),f=He(u,b,b,a),g=Co(d,f),p=wo(d,f),m=(g*.4+p*.6)*100,y=sn(d,b,b),v=sn(f,b,b),I=Eo(y,v),C=Math.max(0,100-I*20),E=pt(s,b,b),D=pt(u,b,b),B=yo(E,D),M=rn(s,d,b,b),ye=rn(u,f,b,b),be=Io(M,ye);return{score:m*o.mask+C*o.hu+B*o.edge+be*o.color,details:{mask:Math.round(m),hu:Math.round(C),edge:Math.round(B),color:Math.round(be)}}}function Co(e,t){let n=0,o=0;for(let a=0;a<e.length;a++)e[a]&&t[a]&&n++,(e[a]||t[a])&&o++;return o>0?n/o:0}function wo(e,t){let n=0,o=0,a=0;for(let i=0;i<e.length;i++)e[i]&&t[i]&&n++,o+=e[i],a+=t[i];return o+a>0?2*n/(o+a):0}function sn(e,t,n){let o=0,a=0,i=0,r=0,s=0,l=0,c=0,u=0,d=0,f=0;for(let A=0;A<n;A++)for(let F=0;F<t;F++){let _=e[A*t+F];_!==0&&(o+=_,a+=F*_,i+=A*_,r+=F*A*_,s+=F*F*_,l+=A*A*_,c+=F*F*A*_,u+=F*A*A*_,d+=F*F*F*_,f+=A*A*A*_)}if(o===0)return new Array(7).fill(0);let g=a/o,p=i/o,m=s/o-g*g,y=l/o-p*p,v=r/o-g*p,I=d/o-3*g*m-g*g*g,C=f/o-3*p*y-p*p*p,E=c/o-2*g*v-p*m-g*g*p,D=u/o-2*p*v-g*y-g*p*p,B=(A,F)=>Math.pow(o,1+(A+F)/2),M=m/B(2,0),ye=y/B(0,2),be=v/B(1,1),H=I/B(3,0),V=C/B(0,3),q=E/B(2,1),z=D/B(1,2),Z=new Array(7);return Z[0]=M+ye,Z[1]=Math.pow(M-ye,2)+4*Math.pow(be,2),Z[2]=Math.pow(H-3*z,2)+Math.pow(3*q-V,2),Z[3]=Math.pow(H+z,2)+Math.pow(q+V,2),Z[4]=(H-3*z)*(H+z)*(Math.pow(H+z,2)-3*Math.pow(q+V,2))+(3*q-V)*(q+V)*(3*Math.pow(H+z,2)-Math.pow(q+V,2)),Z[5]=(M-ye)*(Math.pow(H+z,2)-Math.pow(q+V,2))+4*be*(H+z)*(q+V),Z[6]=(3*q-V)*(H+z)*(Math.pow(H+z,2)-3*Math.pow(q+V,2))-(H-3*z)*(q+V)*(3*Math.pow(H+z,2)-Math.pow(q+V,2)),Z}function Eo(e,t){let n=0;for(let o=0;o<7;o++){let a=e[o]>=0?1:-1,i=t[o]>=0?1:-1,r=e[o]!==0?a*Math.log10(Math.abs(e[o])):0,s=t[o]!==0?i*Math.log10(Math.abs(t[o])):0;n+=Math.abs(r-s)}return n}function cn(e,t){let n={element:"None",confidence:0,allScores:{},iconData:e},o={};for(let[a,i]of Object.entries(t.elements)){let r=fo(e,i);o[a]=Math.round(r),r>n.confidence&&(n={element:a,confidence:Math.round(r),allScores:o,iconData:e})}return n.allScores=o,n}function dn(e,t){de=e,gt=t,Ne={};let n={type:"Human",confidence:0,allScores:{},iconData:e},o={};for(let[a,i]of Object.entries(t.types)){let r=ln(e,i);o[a]=Math.round(r.score),Ne[a]=r.details,r.score>n.confidence&&(n={type:a,confidence:Math.round(r.score),allScores:o,iconData:e})}return n.allScores=o,n}function ht(e){if(!de||!gt)return console.warn("No scan data available for recalculation"),null;let t={maskWeight:e.maskWeight,huWeight:e.huWeight,edgeWeight:e.edgeWeight,colorWeight:e.colorWeight,maskOptions:{backgroundTolerance:e.backgroundTolerance,morphologyKernel:e.morphologyKernel,useAdaptiveBackground:e.useAdaptiveBackground}},n={},o={};for(let[a,i]of Object.entries(gt.types)){let r=ln(de,i,t);n[a]=Math.round(r.score),o[a]=r.details}return Ne=o,{allScores:n,allDetails:o}}function vt(){return Ne}function yt(){return de}function bt(e){if(!de)return null;let t=document.createElement("canvas");t.width=b,t.height=b;let n=t.getContext("2d");n.drawImage(de.canvas,0,0,b,b);let o=n.getImageData(0,0,b,b),a=He(o,b,b,{...e,morphologyKernel:0}),i=He(o,b,b,e),r=pt(o,b,b);return{rawMask:a,cleanedMask:i,edges:r}}var So={fire:10,ice:10,lightning:10,poison:10,dark:10,holy:10,elemental:8,"non-elemental":10,human:10,beast:10,plant:10,aquatic:10,fairy:10,reptile:10,devil:10,undead:10,machine:10,same:8,different:8,all:6,three:6,two:6,one:5,type:5,element:5,familiar:3,familiars:3,lineup:1,active:1,your:0,is:0,on:0,if:0,a:0,an:0,the:0,have:0};function xo(e,t){let n=e.length,o=t.length,a=Array(n+1).fill(null).map(()=>Array(o+1).fill(0));for(let i=0;i<=n;i++)a[i][0]=i;for(let i=0;i<=o;i++)a[0][i]=i;for(let i=1;i<=n;i++)for(let r=1;r<=o;r++){let s=e[i-1]===t[r-1]?0:1;a[i][r]=Math.min(a[i-1][r]+1,a[i][r-1]+1,a[i-1][r-1]+s)}return a[n][o]}function Bo(e,t){if(e===t)return 1;if(e.length===0||t.length===0)return 0;let n=Math.floor(Math.max(e.length,t.length)/2)-1,o=new Array(e.length).fill(!1),a=new Array(t.length).fill(!1),i=0,r=0;for(let u=0;u<e.length;u++){let d=Math.max(0,u-n),f=Math.min(u+n+1,t.length);for(let g=d;g<f;g++)if(!(a[g]||e[u]!==t[g])){o[u]=!0,a[g]=!0,i++;break}}if(i===0)return 0;let s=0;for(let u=0;u<e.length;u++)if(o[u]){for(;!a[s];)s++;e[u]!==t[s]&&r++,s++}let l=(i/e.length+i/t.length+(i-r/2)/i)/3,c=0;for(let u=0;u<Math.min(4,e.length,t.length)&&e[u]===t[u];u++)c++;return l+c*.1*(1-l)}function ko(e,t,n){let o=s=>{let l=new Set,c=s.replace(/\s+/g," ");for(let u=0;u<=c.length-n;u++)l.add(c.substring(u,u+n));return l},a=o(e),i=o(t);if(a.size===0||i.size===0)return 0;let r=0;for(let s of a)i.has(s)&&r++;return 2*r/(a.size+i.size)*100}function Mo(e,t){let n=e.split(/\s+/).filter(r=>r.length>1),o=t.split(/\s+/).filter(r=>r.length>1);if(n.length===0||o.length===0)return 0;let a=0,i=0;for(let r of o){let s=So[r]??2;a+=s;for(let l of n)if(l===r||l.includes(r)||r.includes(l)||xo(l,r)<=Math.max(1,Math.floor(r.length/4))){i+=s;break}}return a>0?i/a*100:0}function un(e,t){let n=Mo(e,t),o=ko(e,t,3),a=Bo(e,t)*100;return n*.5+o*.3+a*.2}function mn(e){let t={flat:null,mult:null},n=e.match(/([+-]\d+)(?!\.\d)/);n&&(t.flat=parseInt(n[1]));let o=e.match(/[x×](\d+\.?\d*)|(\d+\.?\d*)[x×]/i);return o&&(t.mult=parseFloat(o[1]||o[2])),t}function fn(e,t){let n=0,o=0;return e.flat!==null&&t.flatBonus!==void 0&&(o++,e.flat===t.flatBonus?n+=100:Math.abs(e.flat-t.flatBonus)<=1&&(n+=50)),e.mult!==null&&t.multiplierBonus!==void 0&&(o++,Math.abs(e.mult-t.multiplierBonus)<.05?n+=100:Math.abs(e.mult-t.multiplierBonus)<.2&&(n+=50)),o>0?n/o:0}function It(e){let n=h.getState().configConditionalBonuses.bonuses;if(!e||!n)return null;let o=e.toLowerCase().replace(/[\n\r]+/g," ").replace(/\s+/g," ").trim(),a=mn(o),i=null,r=0;for(let s of n){let l=s.name.toLowerCase(),c=un(o,l),u=0;(a.flat!==null||a.mult!==null)&&(u=fn(a,s));let d=u>0?c*.7+u*.3:c;d>r&&d>35&&(r=d,i={...s,matchScore:Math.round(d)})}return i}function Ct(e,t=10){let o=h.getState().configConditionalBonuses.bonuses;if(!e||!o)return[];let a=e.toLowerCase().replace(/[\n\r]+/g," ").replace(/\s+/g," ").trim(),i=mn(a),r=[];for(let s of o){let l=s.name.toLowerCase(),c=un(a,l),u=0;(i.flat!==null||i.mult!==null)&&(u=fn(i,s));let d=u>0?c*.7+u*.3:c;d>20&&r.push({...s,matchScore:Math.round(d)})}return r.sort((s,l)=>l.matchScore-s.matchScore),r.slice(0,t)}var Ce=null,Pe=null;async function Oe(){if(!Ce){if(Pe){await Pe;return}Pe=(async()=>{try{if(typeof Tesseract>"u")throw new Error("Tesseract.js is not loaded");Ce=await Tesseract.createWorker("eng"),console.log("OCR worker initialized")}catch(e){throw console.error("Failed to initialize OCR:",e),e}})(),await Pe}}async function wt(e){if(Ce||await Oe(),!Ce)throw new Error("OCR worker not available");return(await Ce.recognize(e)).data.text.trim()}var Ee={elements:{},types:{}},G=null,we=null;async function gn(){G=document.getElementById("scannerCanvas"),G&&(we=G.getContext("2d",{willReadFrequently:!0}),await $o())}async function $o(){let e=["Fire","Ice","Lightning","Poison","Dark","Holy","None"],t=["Human","Beast","Plant","Aquatic","Fairy","Reptile","Devil","Undead","Machine"];for(let n of e)try{Ee.elements[n]=await De(`element/${n}.png`)}catch{console.warn(`Could not load element reference: ${n}`)}for(let n of t)try{Ee.types[n]=await De(`type/${n}.png`)}catch{console.warn(`Could not load type reference: ${n}`)}}async function Lo(e){let t=$.nameRegion,n=Math.floor(e.width*t.x),o=Math.floor(e.height*t.y),a=Math.floor(e.width*t.w),i=Math.floor(e.height*t.h),r=document.createElement("canvas");r.width=a,r.height=i;let s=r.getContext("2d");s.drawImage(e.canvas,n,o,a,i,0,0,a,i),mt(s,a,i);try{return await Oe(),(await wt(r)).replace(/[\n\r]+/g," ").replace(/\s+/g," ").trim()}catch{return""}}async function Ro(e){let t=$.textRegion,n=Math.floor(e.width*t.x),o=Math.floor(e.height*t.y),a=Math.floor(e.width*t.w),i=Math.floor(e.height*t.h),r=document.createElement("canvas");r.width=a,r.height=i;let s=r.getContext("2d");s.drawImage(e.canvas,n,o,a,i,0,0,a,i),mt(s,a,i);try{await Oe();let l=await wt(r),c=It(l);return{rawText:l,matched:c,confidence:c?.matchScore??0}}catch{return{rawText:"",matched:null,confidence:0}}}async function pn(e,t){if(!e.type.startsWith("image/"))throw new Error("Please upload an image file");if(!G||!we)throw new Error("Scanner not initialized");t?.("Loading image...");let n=URL.createObjectURL(e),o=await De(n);URL.revokeObjectURL(n),G.width=o.width,G.height=o.height,we.drawImage(o,0,0),t?.("Detecting border...");let a=an(G,we);t?.("Detecting rank...");let i=ft(a.borderColor);t?.("Detecting element...");let r=ut(a,$.elementIconRegion),s=cn(r,Ee);t?.("Detecting type...");let l=ut(a,$.typeIconRegion),c=dn(l,Ee);t?.("Extracting name...");let u=await Lo(a);t?.("Extracting conditional...");let d=await Ro(a);return $.debug&&(To(a),a.croppedImageUrl=a.canvas.toDataURL("image/png")),G.width=a.width,G.height=a.height,we.drawImage(a.canvas,0,0),$.debug&&console.log("Scanner Results:",{borderColor:a.borderColor,bounds:a.bounds,rank:i,element:s,type:c,name:u,conditional:d}),t?.("Done!"),{name:u,rank:i,element:s,type:c,conditional:d,croppedImage:a.croppedImageUrl}}function To(e){let t=e.ctx,n=e.width,o=e.height,a=$.elementIconRegion;t.strokeStyle="red",t.lineWidth=2,t.strokeRect(n*a.x,o*a.y,n*a.w,o*a.h),t.fillStyle="red",t.font="12px sans-serif",t.fillText("ELEMENT",n*a.x,o*a.y-2);let i=$.typeIconRegion;t.strokeStyle="blue",t.strokeRect(n*i.x,o*i.y,n*i.w,o*i.h),t.fillStyle="blue",t.fillText("TYPE",n*i.x,o*i.y-2);let r=$.nameRegion;t.strokeStyle="cyan",t.strokeRect(n*r.x,o*r.y,n*r.w,o*r.h),t.fillStyle="cyan",t.fillText("NAME",n*r.x,o*r.y-2);let s=$.textRegion;t.strokeStyle="lime",t.strokeRect(n*s.x,o*s.y,n*s.w,o*s.h),t.fillStyle="lime",t.fillText("TEXT/OCR",n*s.x,o*s.y-2),t.fillStyle="yellow",t.font="14px monospace",t.fillText(`Bounds: L=${e.bounds.left} T=${e.bounds.top} R=${e.bounds.right} B=${e.bounds.bottom}`,5,16),t.fillText(`Border: RGB(${e.borderColor.r}, ${e.borderColor.g}, ${e.borderColor.b})`,5,32)}function Et(){return Ee}function ue(){return $.debug}var Ao={calculator:0,roster:1,info:2,howtouse:3},hn=["famfinder"];function St(e){document.querySelectorAll(".page").forEach(n=>{n.classList.remove("active")}),document.querySelectorAll(".nav-btn").forEach(n=>{n.classList.remove("active")});let t=document.getElementById(`page-${e}`);if(t&&t.classList.add("active"),!hn.includes(e)){let n=document.querySelectorAll(".nav-btn"),o=Ao[e];n[o]&&n[o].classList.add("active")}}function xt(){let t=new URLSearchParams(window.location.search).get("page");return t&&hn.includes(t)?(St(t),!0):!1}function Bt(){document.querySelectorAll("[data-page]").forEach(e=>{e.addEventListener("click",()=>{let t=e.getAttribute("data-page");t&&St(t)})})}var Fo={Common:3,Rare:4,Epic:5,Unique:6,Legendary:6};function X(e){return Fo[e]??3}function me(e){return e.map(t=>X(t.rank))}function vn(e){return(1+X(e))/2}function K(e){return e.map(t=>Math.ceil(vn(t.rank)))}function*kt(e){let t=me(e);if(t.length!==0){if(t.length===1){for(let n=1;n<=t[0];n++)yield[n];return}if(t.length===2){for(let n=1;n<=t[0];n++)for(let o=1;o<=t[1];o++)yield[n,o];return}for(let n=1;n<=t[0];n++)for(let o=1;o<=t[1];o++)for(let a=1;a<=t[2];a++)yield[n,o,a]}}function Mt(e){if(!e?.name)return null;let t=e.name.match(/prevents dice from rolling over (\d+)/i);return t?parseInt(t[1],10):null}function Se(e,t){if(!e?.rank)return 6;let n=X(e.rank),o=Mt(e.conditional),a=n;return o!==null&&(a=Math.min(a,o)),t!==null&&(a=Math.min(a,t)),a}function xe(e){let t=null;for(let n of e)if(n?.conditional){let o=Mt(n.conditional);o!==null&&(t=t===null?o:Math.min(t,o))}return t}var We=new Map;function Do(e){if(We.has(e))return We.get(e);try{let t=new Function("dice","familiars",`return ${e}`);return We.set(e,t),t}catch{return We.set(e,()=>!1),null}}function yn(e,t,n){let o=Do(e);if(!o)return!1;try{return!!o(t,n)}catch{return!1}}function ie(e,t,n){return yn(e.condition,t,n)?{isActive:!0,flatBonus:e.flatBonus||0,multiplierBonus:e.multiplierBonus||0}:{isActive:!1,flatBonus:0,multiplierBonus:0}}function No(e){let t=0,n=0;for(let o of e)t+=o.flatBonus||0,n+=o.multiplierBonus||0;return{flat:t,multiplier:n}}function Ho(e){return{type:e.type,element:e.element,rank:e.rank}}function Be(e,t,n,o){let a=e.reduce((p,m)=>p+m,0),i=No(n),r=0,s=0,l=[];for(let p of o){let m=ie(p,e,t);m.isActive&&(l.push(p.name),r+=m.flatBonus,s+=m.multiplierBonus)}let c=i.flat+r,u=i.multiplier+s,d=a+c,f=u!==0?u:null,g=f?Math.floor(d*f):d;return{diceSum:a,totalFlat:c,totalMultiplier:f,finalResult:g,activeConditionalNames:l}}function O(e,t,n){let o=n.reduce((d,f)=>d+f,0),a=e.map(Ho),i=0,r=0,s=[],l=[];for(let d=0;d<e.length;d++){let f=e[d],g={familiarIndex:d,name:f.name,element:f.element,type:f.type,rank:f.rank,conditionalTriggered:!1,conditionalName:null,flatContribution:0,multiplierContribution:0};if(f.conditional){let p=ie(f.conditional,n,a);p.isActive&&(g.conditionalTriggered=!0,g.conditionalName=f.conditional.name,g.flatContribution=p.flatBonus,g.multiplierContribution=p.multiplierBonus,s.push(f.conditional.name),i+=p.flatBonus,r+=p.multiplierBonus)}l.push(g)}for(let d of t){let f=ie(d,n,a);f.isActive&&(s.push(d.name),i+=f.flatBonus,r+=f.multiplierBonus)}let c=o+i;return{score:r!==0?Math.floor(c*r):c,diceSum:o,totalFlat:i,totalMult:r,activeBonusNames:s,familiarBreakdown:l}}function Ve(e,t){let n=[];function o(a,i){if(i.length===t){n.push([...i]);return}for(let r=a;r<e.length;r++)i.push(e[r]),o(r+1,i),i.pop()}return o(0,[]),n}function Oo(e){return!e||!e.condition||e.condition==="true"?!0:!e.condition.includes("dice")}function Wo(e,t){if(!e.condition||e.condition==="true")return!0;let n=t.map(o=>({type:o.type,element:o.element,rank:o.rank}));try{return new Function("familiars",`return ${e.condition}`)(n)}catch{return!1}}function Vo(e,t){switch(t){case"lowRolls":return[1,1,1];case"highRolls":return me(e);default:return K(e)}}function qo(e,t){switch(t){case"lowRolls":return"Score with dice: 1-1-1";case"highRolls":return`Score with dice: ${me(e).join("-")}`;default:return`Avg dice: ${K(e).map(a=>Number.isInteger(a)?a.toString():a.toFixed(1)).join("-")}`}}function $t(e,t){let n=[];for(let o of kt(e)){let a=O(e,t,o);n.push(a.score)}return n}function zo(e){let t=Math.floor(e.length/2);return e.length%2===0?(e[t-1]+e[t])/2:e[t]}function bn(e,t){return e.filter(o=>o>=t).length/e.length*100}function In(e,t){let n=null,o=-1/0;for(let a of e){let i=$t(a,t);i.sort((s,l)=>s-l);let r=zo(i);if(r>o){o=r;let s=K(a);n={...O(a,t,s),familiars:a,score:Math.round(r),scoreLabel:"Median of all outcomes",testDice:s,medianScore:r}}}return n}function Cn(e,t){let n=null,o=-1/0;for(let a of e){let i=$t(a,t),s=i.reduce((c,u)=>c+u,0)/i.length*.8,l=bn(i,s);if(l>=80&&s>o){o=s;let c=K(a);n={...O(a,t,c),familiars:a,score:Math.round(s),scoreLabel:`${l.toFixed(0)}% above ${Math.round(s)}`,testDice:c,floorPercentage:l,floorThreshold:s}}}if(!n&&e.length>0){let a=-1/0;for(let i of e){let r=$t(i,t),l=r.reduce((u,d)=>u+d,0)/r.length*.8,c=bn(r,l);if(c>a){a=c;let u=K(i);n={...O(i,t,u),familiars:i,score:Math.round(l),scoreLabel:`${c.toFixed(0)}% above ${Math.round(l)}`,testDice:u,floorPercentage:c,floorThreshold:l}}}}return n}function wn(e,t){let n=null,o=-1/0;for(let a of e){let r=O(a,t,[1,1,1]).score,s=K(a),l=O(a,t,s),c=l.score,u=me(a),f=O(a,t,u).score,g=.25*r+.5*c+.25*f;g>o&&(o=g,n={...l,familiars:a,score:Math.round(g),scoreLabel:"Weighted (25/50/25)",testDice:s,balancedComponents:{lowRollScore:r,avgScore:c,highRollScore:f}})}return n}function En(e,t){let n=null,o=-1/0,a=0;for(let i of e){if(!i.every(f=>Oo(f.conditional)))continue;let s=0,l=0,c=1;for(let f of i)f.conditional&&Wo(f.conditional,i)&&(s++,l+=f.conditional.flatBonus||0,c*=f.conditional.multiplierBonus||1);let u=K(i),d=O(i,t,u);(s>a||s===a&&d.score>o)&&(a=s,o=d.score,n={...d,familiars:i,score:d.score,scoreLabel:`${s} guaranteed bonus${s!==1?"es":""}`,testDice:u})}return n}function qe(e,t,n){let o=null,a=-1/0;for(let i of e){let r=Vo(i,n),s=O(i,t,r),l=s.score;l>a&&(a=l,o={...s,familiars:i,score:Math.round(l),scoreLabel:qo(i,n),testDice:r})}return o}function ze(e,t,n,o){let a=Be(e,t,n,o);return{finalResult:a.finalResult,activeConditionals:a.activeConditionalNames,diceSum:a.diceSum,totalFlat:a.totalFlat,totalMultiplier:a.totalMultiplier}}function Lt(e,t,n,o,a){let i=[];for(let r=0;r<e.length;r++){let s=e[r],l=t[r]?.rank??"Common",c=X(l),u=[];for(let g=1;g<=c;g++){let p=[...e];p[r]=g;let m=ze(p,t,n,o);m.finalResult>=a&&u.push({value:g,finalResult:m.finalResult,activeConditionals:m.activeConditionals,diceSum:m.diceSum,totalFlat:m.totalFlat,totalMultiplier:m.totalMultiplier})}let d=u.length>0?Math.round(u.length/c*100):null,f=u.some(g=>g.value===s);i.push({dieIndex:r,dieName:`Dice ${r+1}`,currentValue:s,passingValues:u,odds:d,currentPasses:f,maxDice:c,rank:l})}return i}function Rt(e,t,n,o,a=5){let i=e.filter(d=>d!==null&&d.rank!==void 0);if(i.length===0)return[];let r=i.map(d=>({type:d.type,element:d.element,rank:d.rank})),s=xe(e),l=i.map(d=>Se(d,s)),c=[],u=i.length;if(u===1)for(let d=1;d<=l[0];d++){let f=[d],g=ze(f,r,t,n);if(g.finalResult>=o){let p=(l[0]-d+1)/l[0]*100;c.push({dice:[...f],diceSum:d,finalScore:g.finalResult,probability:p,activeConditionals:g.activeConditionals})}}else if(u===2)for(let d=1;d<=l[0];d++)for(let f=1;f<=l[1];f++){let g=[d,f],p=ze(g,r,t,n);if(p.finalResult>=o){let m=(l[0]-d+1)/l[0],y=(l[1]-f+1)/l[1],v=m*y*100;c.push({dice:[...g],diceSum:d+f,finalScore:p.finalResult,probability:v,activeConditionals:p.activeConditionals})}}else for(let d=1;d<=l[0];d++)for(let f=1;f<=l[1];f++)for(let g=1;g<=l[2];g++){let p=[d,f,g],m=ze(p,r,t,n);if(m.finalResult>=o){let y=(l[0]-d+1)/l[0],v=(l[1]-f+1)/l[1],I=(l[2]-g+1)/l[2],C=y*v*I*100;c.push({dice:[...p],diceSum:d+f+g,finalScore:m.finalResult,probability:C,activeConditionals:m.activeConditionals})}}return c.sort((d,f)=>f.probability-d.probability),c.slice(0,a)}function w(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML}function j(e){return document.getElementById(e)}function Tt(e){let t=j("diceSum");t&&(t.textContent=String(e.diceSum));let n=j("flatBonus");n&&(n.textContent=(e.totalFlat>=0?"+":"")+e.totalFlat);let o=j("totalMult"),a=o?.closest(".result-stat");o&&a&&(e.totalMultiplier!==null?(a.style.display="",o.textContent="\xD7"+e.totalMultiplier.toFixed(2)):a.style.display="none");let i=j("finalResult");i&&(i.textContent=String(e.finalResult),i.className="final-result "+(e.passed?"pass":"fail"));let r=j("resultStatus");r&&(r.textContent=e.passed?"PASS":"FAIL",r.className="result-status "+(e.passed?"pass":"fail"));let s=j("difference");s&&(s.textContent=e.difference>=0?`Beat by ${e.difference}`:`Failed by ${Math.abs(e.difference)}`)}function jo(e,t){let n=[];return e!==0&&n.push(`<span class="cond-flat">${e>=0?"+":""}${e}</span>`),t!==0&&t!==1&&n.push(`<span class="cond-mult">\xD7${t.toFixed(2)}</span>`),n.length>0?n.join(" "):""}function je(e){let t=j("waveSummaryConditionals");t&&(e.length===0?t.innerHTML='<span class="no-conditionals">No conditionals</span>':t.innerHTML=e.map(n=>{let{conditional:o,isActive:a,familiarName:i,familiarIndex:r,isManuallyDisabled:s}=n,l="active";s?l="manually-disabled":a||(l="inactive");let c=jo(o.flatBonus,o.multiplierBonus),u=i?`<span class="cond-familiar">${i}:</span> ${o.name}`:o.name,d=s?"Click to enable":"Click to disable";return`<span class="conditional-pill ${l}"
                      data-action="toggle-conditional"
                      data-familiar-index="${r}"
                      data-conditional-id="${o.id||""}"
                      title="${d}">
          <span class="cond-name">${u}</span>
          ${c?`<span class="cond-values">${c}</span>`:""}
        </span>`}).join(""))}function At(e,t){let n=j("rerollSection"),o=j("rerollSuggestions");if(!(!n||!o)){if(t){n.style.display="none";return}n.style.display="block",o.innerHTML=e.map(a=>{let i="reroll-item",r="reroll-target",s="";return a.passingValues.length===0?(i+=" impossible",r+=" impossible",s="Impossible alone"):(i+=" can-reroll",r+=" possible",s=`Need: ${a.passingValues.map(c=>c.value).join(", ")}`),`
        <div class="${i}">
          <div class="reroll-die-name">${a.dieName} (d${a.maxDice})</div>
          <div class="reroll-current">Current: ${a.currentValue} | ${a.rank}</div>
          <div class="${r}">${s}</div>
          ${a.odds!==null?`<div class="reroll-odds">${a.odds}% chance (${a.passingValues.length}/${a.maxDice})</div>`:""}
        </div>
      `}).join("")}}function Sn(e){let t=j("passingCombosResult");if(!t)return;if(e.length===0){t.innerHTML=`
      <div class="passing-combos-empty">
        Cannot pass with current lineup
      </div>
    `,t.style.display="block";return}let n=e.map((o,a)=>{let i=o.dice.map((s,l)=>`<span class="combo-die">D${l+1}: ${s}</span>`).join(""),r=o.probability.toFixed(1);return`
      <div class="passing-combo">
        <div class="combo-rank">#${a+1}</div>
        <div class="combo-dice">${i}</div>
        <div class="combo-score">Score: ${o.finalScore}</div>
        <div class="combo-probability">${r}%</div>
      </div>
    `}).join("");t.innerHTML=`
    <div class="passing-combos-header">Top Passing Combinations</div>
    <div class="passing-combos-list">
      ${n}
    </div>
  `,t.style.display="block"}function Q(e){let t=[];return e.flatBonus&&e.flatBonus!==0&&t.push(`${e.flatBonus>=0?"+":""}${e.flatBonus}`),e.multiplierBonus&&e.multiplierBonus!==0&&e.multiplierBonus!==1&&t.push(`\xD7${e.multiplierBonus}`),t.length>0?t.join(", "):"No bonus"}function xn(e){let t=Q(e);return t!=="No bonus"?`${e.name} (${t})`:e.name}function Y(e){if(!e)return!1;let t=(e.name||"").toLowerCase(),n=(e.condition||"").toLowerCase();return!1}function fe(e){return e&&(e.name||"").toLowerCase().includes("dice add up to")?"Misleading wording: Each die must individually meet the threshold":!1}function Bn(e){return`
    <div class="familiar-card empty" data-slot="${e}" data-action="add">
      <div class="familiar-card-add">+ Add Familiar ${e+1}</div>
    </div>
  `}function kn(e,t){let n=`rank-${e.rank.toLowerCase()}`,o=null,a="",i="";if(e.conditional){o=xn(e.conditional);let r=Y(e.conditional);r&&(a=`<span class="bugged-badge" title="${w(r)}">BUGGED</span>`);let s=fe(e.conditional);s&&(i=`<span class="info-badge-inline" title="${w(s)}">Info</span>`)}return`
    <div class="familiar-card ${n}" data-slot="${t}">
      ${a}
      <div class="familiar-card-info">
        <div class="familiar-card-name">${w(e.name||`Familiar ${t+1}`)}</div>
        <div class="familiar-card-details">
          <span class="rank-text ${n}">${e.rank}</span>${e.element!=="None"?` \xB7 <span class="element-text element-${e.element.toLowerCase()}">${e.element}</span>`:""} \xB7 ${e.type}
        </div>
        <div class="familiar-card-conditional ${o?"":"none"}">
          ${o?w(o):"No conditional"}${i}
        </div>
      </div>
      <div class="familiar-card-actions">
        <button class="familiar-edit-btn" data-action="edit" data-slot="${t}">Edit</button>
        <button class="familiar-delete-btn" data-action="delete" data-slot="${t}">\xD7</button>
      </div>
    </div>
  `}function Mn(e){return e.map((t,n)=>t&&t.rank?kn(t,n):Bn(n)).join("")}function ee(e){let t=document.getElementById("familiarsGrid");t&&(t.innerHTML=Mn(e))}function Ln(e){let t=`rank-${e.rank.toLowerCase()}`,n=e.disabled?"disabled":"",o=Y(e.conditional)?"bugged":"",a="",i="";if(e.conditional){let l=Q(e.conditional),c=fe(e.conditional);c&&(i=`<span class="info-badge-inline" title="${w(c)}">Info</span>`),a=`<div class="roster-conditional">${w(e.conditional.name)} (${l})</div>`}let r=e.wave?`wave-${e.wave}`:"",s=e.wave?`<div class="roster-item-wave ${r}">Wave ${e.wave}</div>`:"";return`
    <div class="roster-item ${t} ${n} ${o} ${r}" data-familiar-id="${e.id}">
      ${s}
      <div class="roster-item-info">
        <div class="roster-item-name-row">
          <span class="roster-item-name">${w(e.name)}</span>
          ${i}
        </div>
        <div class="roster-item-details">
          <span class="rank-text ${t}">${e.rank}</span> \xB7 <span class="element-text element-${e.element.toLowerCase()}">${e.element}</span> \xB7 ${e.type}
        </div>
        ${a}
      </div>
      <div class="roster-item-actions">
        <button class="roster-btn edit" data-action="edit" data-id="${e.id}">Edit</button>
        <button class="roster-btn toggle" data-action="toggle" data-id="${e.id}">
          ${e.disabled?"Enable":"Disable"}
        </button>
        <button class="roster-btn delete" data-action="delete" data-id="${e.id}">Delete</button>
      </div>
    </div>
  `}var $n={Common:1,Rare:2,Epic:3,Unique:4,Legendary:5};function _e(e,t){let n=[...e];if(t.search){let o=t.search.toLowerCase();n=n.filter(a=>a.name.toLowerCase().includes(o)||(a.conditional?.name?.toLowerCase().includes(o)??!1))}if(t.rank&&(n=n.filter(o=>o.rank===t.rank)),t.element&&(n=n.filter(o=>o.element===t.element)),t.type&&(n=n.filter(o=>o.type===t.type)),t.wave)if(t.wave==="none")n=n.filter(o=>!o.wave);else{let o=parseInt(t.wave);n=n.filter(a=>a.wave===o)}return n.sort((o,a)=>{switch(t.sortBy){case"rank":return($n[a.rank]||0)-($n[o.rank]||0);case"element":return o.element.localeCompare(a.element);case"type":return o.type.localeCompare(a.type);case"wave":let i=o.wave??999,r=a.wave??999;return i-r;default:return o.name.localeCompare(a.name)}}),n}function Rn(e,t){let n=t?_e(e,t):e;return n.length===0?e.length>0?'<div class="roster-empty">No familiars match your filters.</div>':'<div class="roster-empty">No familiars in collection. Add one below or use the scanner.</div>':n.map(Ln).join("")}function _o(){return{search:document.getElementById("rosterSearchInput")?.value||"",rank:document.getElementById("rosterFilterRank")?.value||"",element:document.getElementById("rosterFilterElement")?.value||"",type:document.getElementById("rosterFilterType")?.value||"",wave:document.getElementById("rosterFilterWave")?.value||"",sortBy:document.getElementById("rosterSortBy")?.value||"name"}}function L(e,t){let n=t||_o(),o=_e(e,n),a=document.getElementById("rosterList");a&&(a.innerHTML=Rn(e,n));let i=document.getElementById("rosterCount");if(i){let r=e.length,s=o.length;s===r?i.textContent=`${r} familiar${r!==1?"s":""} in collection`:i.textContent=`Showing ${s} of ${r} familiars`}}function x(e,t=2e3){let n=document.getElementById("toastContainer");if(!n)return;let o=document.createElement("div");o.className="toast toast-success",o.textContent=e,n.appendChild(o),setTimeout(()=>{o.classList.add("toast-out"),setTimeout(()=>{o.remove()},200)},t)}var ke=new Set;function Tn(e,t){return`${e}-${t||"unknown"}`}function Ue(){ke.clear()}function Ft(e,t){return ke.has(Tn(e,t))}function An(e,t){let n=Tn(e,t);ke.has(n)?ke.delete(n):ke.add(n),N()}function Uo(){let e=[],t=h.getState();for(let n=0;n<3;n++){let o=t.calcFamiliars[n];if(o&&o.rank){let a=document.getElementById(`dice${n+1}`);e.push(parseInt(a?.value)||1)}}return e}function re(){let t=h.getState().calcFamiliars,n=xe(t);for(let o=0;o<3;o++){let a=document.getElementById(`dice${o+1}`);if(!a)continue;let i=t[o],r=Se(i,n),s=parseInt(a.value)||1;a.innerHTML="";for(let l=1;l<=r;l++){let c=document.createElement("option");c.value=String(l),c.textContent=String(l),a.appendChild(c)}a.value=String(Math.min(s,r))}}function Fn(){let e=document.getElementById("difficulty");return parseInt(e?.value)||0}function Go(e){let t=document.querySelector(".calc-row"),n=document.querySelector(".results");t&&t.classList.toggle("calculator-disabled",e),n&&n.classList.toggle("calculator-disabled",e)}function N(){let e=h.getState(),t=[];e.calcFamiliars.forEach((p,m)=>{p!==null&&p.rank!==void 0&&t.push({fam:p,originalIndex:m})});let n=t.map(p=>p.fam);if(Go(n.length===0),n.length===0){je([]);return}let o=Uo(),a=Fn(),i=n.map(p=>({type:p.type,element:p.element,rank:p.rank})),r=[];for(let{fam:p,originalIndex:m}of t)p.conditional&&!Ft(m,p.conditional.id)&&r.push(p.conditional);let s=Be(o,i,e.bonusItems,r),l=s.finalResult>=a,c=s.finalResult-a,u=[];for(let{fam:p,originalIndex:m}of t)if(p.conditional){let y=Ft(m,p.conditional.id),v=y?{isActive:!1,flatBonus:0,multiplierBonus:0}:ie(p.conditional,o,i);u.push({conditional:p.conditional,isActive:v.isActive,familiarName:p.name,familiarIndex:m,isManuallyDisabled:y})}Tt({...s,passed:l,difference:c}),je(u);let d=document.getElementById("activeBonusesDisplay");if(d)if(e.bonusItems.length>0){let p=e.bonusItems.map(m=>{let y=m.flatBonus!==0?`+${m.flatBonus}`:"",v=m.multiplierBonus&&m.multiplierBonus!==0&&m.multiplierBonus!==1?`\xD7${m.multiplierBonus}`:"";return`<span class="active-item">${w(m.name)} (${y}${y&&v?", ":""}${v})</span>`}).join(", ");d.innerHTML=`<strong>Active Items:</strong> ${p}`}else d.innerHTML="";let f=n.map(p=>({type:p.type,element:p.element,rank:p.rank})),g=Lt(o,f,e.bonusItems,r,a);At(g,l)}function Me(e,t){Ue(),h.setState(n=>{let o=[...n.calcFamiliars];return o[e]=t,{calcFamiliars:o}}),ee(h.getState().calcFamiliars),re(),N()}function Dt(e){Me(e,null)}function Dn(){Ue(),h.setState({calcFamiliars:[null,null,null],currentWave:null}),ee(h.getState().calcFamiliars),re(),N(),document.querySelectorAll(".load-wave-btn").forEach(t=>{t.classList.remove("active")});let e=document.getElementById("currentWaveLabel");e&&(e.textContent="")}function Nt(){Ue(),h.setState({calcFamiliars:[null,null,null],currentWave:null,savedWaves:{1:[null,null,null],2:[null,null,null],3:[null,null,null]}}),k(),ee(h.getState().calcFamiliars),re(),N(),document.querySelectorAll(".load-wave-btn").forEach(t=>{t.classList.remove("active")});let e=document.getElementById("currentWaveLabel");e&&(e.textContent="")}function Ht(e){let t=h.getState(),n={...t.savedWaves,[e]:[...t.calcFamiliars]};h.setState({savedWaves:n,currentWave:e}),k();let o=document.getElementById("currentWaveLabel");o&&(o.textContent=`(Wave ${e})`),x(`Saved to Wave ${e}`)}function Ge(e){Ue();let n=[...h.getState().savedWaves[e]];h.setState({calcFamiliars:n,currentWave:e}),ee(n),re();let o=document.getElementById("currentWaveLabel");o&&(o.textContent=`(Wave ${e})`),document.querySelectorAll(".load-wave-btn").forEach(i=>{i.classList.remove("active")});let a=document.querySelector(`[data-action="load-wave"][data-wave="${e}"]`);a&&a.classList.add("active"),N()}function $e(e){let t=h.getState(),n=t.characters.findIndex(i=>i.id===t.currentCharacterId);if(n===-1)return;let o={...e,id:Date.now()},a=[...t.characters];a[n].roster=[...a[n].roster,o],h.setState({characters:a}),k(),L(a[n].roster)}function Pt(e){let t=h.getState(),n=t.characters.findIndex(a=>a.id===t.currentCharacterId);if(n===-1)return;let o=[...t.characters];o[n].roster=o[n].roster.filter(a=>a.id!==e),h.setState({characters:o}),k(),L(o[n].roster)}function Ot(e){let t=h.getState(),n=t.characters.findIndex(r=>r.id===t.currentCharacterId);if(n===-1)return;let o=[...t.characters],a=[...o[n].roster],i=a.findIndex(r=>r.id===e);i!==-1&&(a[i]={...a[i],disabled:!a[i].disabled},o[n].roster=a,h.setState({characters:o}),k(),L(a))}function Wt(e){h.setState({currentCharacterId:e,currentWave:null}),k();let t=R.getCurrentRoster(h.getState());L(t),document.querySelectorAll(".load-wave-btn").forEach(o=>{o.classList.remove("active")});let n=document.getElementById("currentWaveLabel");n&&(n.textContent="")}function Ko(e){h.setState(t=>({bonusItems:[...t.bonusItems,e]})),k(),Ke(),N()}function Nn(e){h.setState(t=>({bonusItems:t.bonusItems.filter((n,o)=>o!==e)})),k(),Ke(),N()}function Ke(){let e=document.getElementById("bonusItemsList");if(!e)return;let{bonusItems:t}=h.getState();if(t.length===0){e.innerHTML='<div class="no-items">No bonus items added. Click "+ Add Item" to add one.</div>';return}e.innerHTML=t.map((n,o)=>{let a=n.flatBonus<0?"flat negative":"flat",i=n.flatBonus!==0?`<span class="${a}">${n.flatBonus>=0?"+":""}${n.flatBonus} flat</span>`:"",r=n.multiplierBonus!==1&&n.multiplierBonus!==0?`<span class="mult">\xD7${n.multiplierBonus}</span>`:"",s=i&&r?", ":"";return`
        <div class="bonus-item">
          <span class="bonus-name">${w(n.name)}</span>
          <span class="bonus-stats">${i}${s}${r}</span>
          <button class="delete-btn" data-action="delete-bonus-item" data-index="${o}">Delete</button>
        </div>
      `}).join("")}function Ye(e){let t=document.getElementById("bonusItemSearchResults");if(!t)return;let o=h.getState().configBonusItems.items||[];if(!e.trim()){t.innerHTML='<div class="search-prompt">Type to search for items...</div>';return}let a=e.toLowerCase(),i=o.filter(r=>{let s=r.name.toLowerCase().includes(a),l=r.description?.toLowerCase().includes(a);return s||l});if(i.length===0){t.innerHTML='<div class="no-results">No items found</div>';return}t.innerHTML=i.map((r,s)=>{let l=r.flatBonus!==0?`<span class="flat${r.flatBonus<0?" negative":""}">${r.flatBonus>=0?"+":""}${r.flatBonus}</span>`:"",c=r.multiplierBonus&&r.multiplierBonus!==0?`<span class="mult">\xD7${r.multiplierBonus}</span>`:"",u=r.description||"";return`
        <div class="bonus-item-result" data-action="apply-bonus-item" data-item-index="${s}" data-query="${w(e)}">
          <div class="bonus-item-result-info">
            <div class="bonus-item-result-name">${w(r.name)}</div>
            <div class="bonus-item-result-stats">${l}${l&&c?" ":""}${c}</div>
            ${u?`<div class="bonus-item-result-desc">${w(u)}</div>`:""}
          </div>
          <button class="apply-btn">Add</button>
        </div>
      `}).join("")}function Hn(e,t){let o=h.getState().configBonusItems.items||[],a=t.toLowerCase(),r=o.filter(c=>{let u=c.name.toLowerCase().includes(a),d=c.description?.toLowerCase().includes(a);return u||d})[e];if(!r)return;Ko({id:`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:r.name,description:r.description||"",flatBonus:r.flatBonus||0,multiplierBonus:r.multiplierBonus||0});let s=document.getElementById("bonusItemModal");s&&(s.style.display="none");let l=document.getElementById("bonusItemSearch");l&&(l.value=""),Ye("")}function Pn(){let e=h.getState(),t=e.calcFamiliars,n=Fn(),o=[];t.forEach((i,r)=>{i!==null&&i.rank!==void 0&&i.conditional&&(Ft(r,i.conditional.id)||o.push(i.conditional))});let a=Rt(t,e.bonusItems,o,n,5);Sn(a)}var Ze=[{value:"",label:"-- Select Rank --"},{value:"Common",label:"Common (D3)",color:"#9d9d9d"},{value:"Rare",label:"Rare (D4)",color:"#0070dd"},{value:"Epic",label:"Epic (D5)",color:"#a335ee"},{value:"Unique",label:"Unique (D6)",color:"#ff8000"},{value:"Legendary",label:"Legendary (D6)",color:"#1eff00"}],Je=[{value:"None",label:"None"},{value:"Fire",label:"Fire",icon:"element/Fire.png"},{value:"Poison",label:"Poison",icon:"element/Poison.png"},{value:"Lightning",label:"Lightning",icon:"element/Lightning.png"},{value:"Ice",label:"Ice",icon:"element/Ice.png"},{value:"Dark",label:"Dark",icon:"element/Dark.png"},{value:"Holy",label:"Holy",icon:"element/Holy.png"}],Xe=[{value:"Human",label:"Human",icon:"type/Human.png"},{value:"Beast",label:"Beast",icon:"type/Beast.png"},{value:"Plant",label:"Plant",icon:"type/Plant.png"},{value:"Aquatic",label:"Aquatic",icon:"type/Aquatic.png"},{value:"Fairy",label:"Fairy",icon:"type/Fairy.png"},{value:"Reptile",label:"Reptile",icon:"type/Reptile.png"},{value:"Devil",label:"Devil",icon:"type/Devil.png"},{value:"Undead",label:"Undead",icon:"type/Undead.png"},{value:"Machine",label:"Machine",icon:"type/Machine.png"}];function te(e){let t=document.getElementById(e.containerId);if(!t)throw new Error(`Container ${e.containerId} not found`);let n=e.defaultValue||e.options[0]?.value||"",o=!1,a=document.createElement("div");a.className="icon-dropdown";let i=document.createElement("div");i.className="icon-dropdown-selected";let r=document.createElement("div");r.className="icon-dropdown-options",a.appendChild(i),document.body.appendChild(r);function s(){let m=e.options.find(y=>y.value===n);if(m){let y=m.color?`style="color: ${m.color}"`:"";i.innerHTML=`
        ${m.icon?`<img src="${m.icon}" alt="" class="icon-dropdown-icon">`:""}
        <span class="icon-dropdown-label" ${y}>${m.label}</span>
        <span class="icon-dropdown-arrow">\u25BC</span>
      `}else i.innerHTML=`
        <span class="icon-dropdown-label">${e.placeholder||"Select..."}</span>
        <span class="icon-dropdown-arrow">\u25BC</span>
      `}function l(){r.innerHTML=e.options.map(m=>{let y=m.color?`style="color: ${m.color}"`:"";return`
        <div class="icon-dropdown-option ${m.value===n?"selected":""}"
             data-value="${m.value}">
          ${m.icon?`<img src="${m.icon}" alt="" class="icon-dropdown-icon">`:""}
          <span class="icon-dropdown-label" ${y}>${m.label}</span>
        </div>
      `}).join("")}function c(){let m=i.getBoundingClientRect();r.style.position="fixed",r.style.top=`${m.bottom}px`,r.style.left=`${m.left}px`,r.style.width=`${m.width}px`,r.style.zIndex="10000"}function u(){o=!o,a.classList.toggle("open",o),r.classList.toggle("open",o),o&&c()}function d(){o=!1,a.classList.remove("open"),r.classList.remove("open")}function f(m){n=m,s(),l(),d(),e.onChange?.(m)}i.addEventListener("click",m=>{m.stopPropagation(),u()}),r.addEventListener("click",m=>{let v=m.target.closest(".icon-dropdown-option");if(v){let I=v.getAttribute("data-value");I&&f(I)}});let g=m=>{a.contains(m.target)||d()};document.addEventListener("click",g);let p=m=>{o&&!r.contains(m.target)&&d()};return window.addEventListener("scroll",p,!0),s(),l(),t.appendChild(a),{getValue:()=>n,setValue:m=>{n=m,s(),l()},destroy:()=>{document.removeEventListener("click",g),window.removeEventListener("scroll",p,!0),a.remove(),r.remove()}}}function On(e){let t=`rank-${e.rank.toLowerCase()}`,n=e.conditional?`<span class="picker-item-bonus">${Q(e.conditional)}</span>`:"",o=e.conditional?`<div class="picker-item-condition">${w(e.conditional.name)}</div>`:"";return`
    <div class="picker-result-item" data-action="select-picker-familiar" data-familiar-id="${e.id}">
      <div class="picker-item-row">
        <span class="picker-item-name">${w(e.name)}</span>
        <span class="picker-item-stats">
          <span class="${t}">${e.rank}</span> \xB7 ${e.element} \xB7 ${e.type}
        </span>
        ${n}
      </div>
      ${o}
    </div>
  `}function Vt(e){let t=null;function n(){return{search:document.getElementById(e.searchInputId)?.value||"",rank:document.getElementById(e.filterRankId)?.value||"",element:document.getElementById(e.filterElementId)?.value||"",type:document.getElementById(e.filterTypeId)?.value||"",wave:"",sortBy:"name"}}function o(){let m=document.getElementById(e.resultsContainerId);if(!m)return;let v=R.getCurrentRoster(h.getState()).filter(M=>!M.disabled),I=n(),C=_e(v,I);if(C.length===0){v.length===0?m.innerHTML='<div class="picker-empty">No familiars in collection.</div>':m.innerHTML='<div class="picker-empty">No familiars match filters.</div>';return}let E=C.slice(0,10),D=C.length-10,B=E.map(On).join("");D>0&&(B+=`<div class="picker-more">+${D} more. Refine search.</div>`),m.innerHTML=B}function a(){let m=document.getElementById(e.searchInputId),y=document.getElementById(e.filterRankId),v=document.getElementById(e.filterElementId),I=document.getElementById(e.filterTypeId);m&&(m.value=""),y&&(y.value=""),v&&(v.value=""),I&&(I.value=""),o()}function i(){t&&clearTimeout(t),t=window.setTimeout(()=>{o(),t=null},200)}let r=document.getElementById(e.searchInputId),s=document.getElementById(e.filterRankId),l=document.getElementById(e.filterElementId),c=document.getElementById(e.filterTypeId),u=document.getElementById(e.resultsContainerId),d=()=>i(),f=()=>o(),g=m=>{let v=m.target.closest('[data-action="select-picker-familiar"]');if(v){let I=parseInt(v.getAttribute("data-familiar-id")||"0",10),E=R.getCurrentRoster(h.getState()).find(D=>D.id===I);E&&e.onSelect(E)}};r?.addEventListener("input",d),s?.addEventListener("change",f),l?.addEventListener("change",f),c?.addEventListener("change",f),u?.addEventListener("click",g);function p(){t&&clearTimeout(t),r?.removeEventListener("input",d),s?.removeEventListener("change",f),l?.removeEventListener("change",f),c?.removeEventListener("change",f),u?.removeEventListener("click",g)}return{refresh:o,clear:a,destroy:p}}function Wn(e){let t=new Map;for(let n of e){let o=n.name;t.has(o)||t.set(o,[]),t.get(o).push(n)}return Array.from(t.entries()).map(([n,o])=>({name:n,variants:o,variantCount:o.length}))}function Yo(e){return e.prePatch===!0}function Le(e){let t={selectedConditional:null,selectedTrigger:null,triggerVariants:[],triggerMatches:[]};function n(u){return document.getElementById(u)}function o(){let u=n(e.searchInputId),d=n(e.resultsContainerId),f=n(e.variantSectionId);if(!u||!d)return;let g=u.value.toLowerCase().trim(),p=e.getRank?.()||null,m=e.prePatchCheckboxId?n(e.prePatchCheckboxId)?.checked:!1;if(f&&(f.style.display="none"),!g){d.style.display="none";return}let v=(h.getState().configConditionalBonuses.bonuses||[]).filter(C=>!m&&p&&C.rarity!==p?!1:C.name.toLowerCase().includes(g)||C.condition.toLowerCase().includes(g)),I=Wn(v);t.triggerMatches=I,I.length===0?d.innerHTML='<div style="padding: 10px; color: #666;">No conditions found</div>':d.innerHTML=I.slice(0,15).map((C,E)=>`
          <div class="trigger-result-item" data-trigger-index="${E}">
            <span class="trigger-name">${w(C.name)}</span>
            <span class="trigger-variants">${C.variantCount} variant${C.variantCount>1?"s":""}</span>
          </div>
        `).join(""),d.style.display="block"}function a(u){let d=t.triggerMatches[u];if(!d)return;let f=n(e.resultsContainerId),g=n(e.variantSectionId),p=n(e.triggerNameId),m=n(e.variantPillsId);t.selectedTrigger=d.name,t.triggerVariants=d.variants,f&&(f.style.display="none"),p&&(p.textContent=d.name),i(m),g&&(g.style.display="block")}function i(u){u&&(u.innerHTML=t.triggerVariants.map((d,f)=>{let g=Q(d),p=(d.rarity||d.rank||"Common").toLowerCase(),m=Yo(d),y=fe(d),v=t.selectedConditional&&t.selectedConditional.id===d.id;return`
          <div class="bonus-pill ${p} ${m?"bugged":""} ${v?"selected":""}"
               data-variant-index="${f}"
               ${y?`title="${w(y)}"`:""}>
            <span class="pill-stats">${g}</span>
            ${m?'<span class="pill-bugged">BUGGED</span>':""}
                      </div>
        `}).join(""))}function r(u){let d=t.triggerVariants[u];d&&(t.selectedConditional=d,l(),i(n(e.variantPillsId)),e.onSelect?.(d))}function s(){let u=n(e.searchInputId),d=n(e.resultsContainerId),f=n(e.variantSectionId);t.selectedConditional=null,t.selectedTrigger=null,t.triggerVariants=[],t.triggerMatches=[],u&&(u.value=""),d&&(d.style.display="none"),f&&(f.style.display="none"),l(),e.onClear?.()}function l(){let u=n(e.displayId);if(u)if(t.selectedConditional){let d=Q(t.selectedConditional);u.innerHTML=`
        <div class="cond-info">
          <div class="cond-name">${w(t.selectedConditional.name)}</div>
          <div class="cond-stats">${d}</div>
        </div>
        <button class="remove-cond" data-action="remove-conditional">\xD7</button>
      `,u.style.display="flex"}else u.style.display="none"}function c(u){let f=(h.getState().configConditionalBonuses.bonuses||[]).filter(m=>m.rarity===u),g=Wn(f);t.triggerMatches=g;let p=n(e.resultsContainerId);if(p){if(g.length===0){p.style.display="none";return}p.innerHTML=g.slice(0,10).map((m,y)=>`
        <div class="trigger-result-item" data-trigger-index="${y}">
          <span class="trigger-name">${w(m.name)}</span>
          <span class="trigger-variants">${m.variantCount} variant${m.variantCount>1?"s":""}</span>
        </div>
      `).join(""),p.style.display="block"}}return{search:o,selectTrigger:a,selectVariant:r,clear:s,showRankBasedTriggers:c,getSelected:()=>t.selectedConditional,setSelected:u=>{t.selectedConditional=u,l()},updateDisplay:l}}var W=null,T=null,U=null,Ut=null,ot=null,Gt=null,Kt=null,se=null,pe=null,he=null;function Yt(){Bt(),ea(),ta(),oa(),aa(),ia(),Zo(),Jo(),la(),ca(),da(),ma(),pa(),ha(),xa(),Da(),Ke()}function Zo(){ot=te({containerId:"familiarEditRankContainer",options:Ze,defaultValue:"",onChange:()=>{W?.search()}}),Gt=te({containerId:"familiarEditElementContainer",options:Je,defaultValue:"None"}),Kt=te({containerId:"familiarEditTypeContainer",options:Xe,defaultValue:"Human"}),se=te({containerId:"rosterRankContainer",options:Ze,defaultValue:"Common",onChange:()=>{T?.search()}}),pe=te({containerId:"rosterElementContainer",options:Je,defaultValue:"None"}),he=te({containerId:"rosterTypeContainer",options:Xe,defaultValue:"Human"})}function Jo(){Ut=Vt({searchInputId:"pickerSearch",resultsContainerId:"pickerResults",filterRankId:"pickerFilterRank",filterElementId:"pickerFilterElement",filterTypeId:"pickerFilterType",onSelect:t=>{let n=document.getElementById("familiarEditSlot"),o=parseInt(n?.value||"0",10),a={id:t.id,name:t.name,rank:t.rank,element:t.element,type:t.type,conditional:t.conditional};Me(o,a);let i=document.getElementById("familiarModal");i&&(i.style.display="none"),x(`Added ${t.name} to slot ${o+1}`)}});let e=document.querySelector('[data-action="toggle-picker"]');e&&e.addEventListener("click",Xo)}function Xo(){let e=document.getElementById("familiarPickerContent"),t=document.querySelector(".picker-toggle-icon");e&&t&&(e.style.display!=="none"?(e.style.display="none",t.classList.remove("expanded")):(e.style.display="block",t.classList.add("expanded"),Ut?.refresh()))}function Qo(){let e=document.getElementById("familiarPickerContent"),t=document.querySelector(".picker-toggle-icon");e&&(e.style.display="none"),t&&t.classList.remove("expanded")}function ea(){let e=document.getElementById("familiarsGrid");e&&e.addEventListener("click",r=>{let s=r.target,l=s.getAttribute("data-action"),c=s.getAttribute("data-slot"),u=c!==null?parseInt(c):-1;l==="add"||l==="edit"?Vn(u):l==="delete"&&u>=0&&Dt(u);let d=s.closest(".familiar-card");if(d&&!l){let f=parseInt(d.getAttribute("data-slot")||"-1");f>=0&&d.classList.contains("empty")&&Vn(f)}});let t=document.querySelector('[data-action="empty-wave"]');t&&t.addEventListener("click",()=>{Dn()});let n=document.querySelector('[data-action="reset-all"]');n&&n.addEventListener("click",()=>{let r=document.getElementById("resetConfirmModal");r&&(r.style.display="flex")});let o=document.querySelector('[data-action="confirm-reset"]');o&&o.addEventListener("click",()=>{Nt();let r=document.getElementById("resetConfirmModal");r&&(r.style.display="none")});let a=document.getElementById("difficulty");a&&(a.addEventListener("change",N),a.addEventListener("input",N));let i=document.getElementById("waveSummaryConditionals");i&&i.addEventListener("click",r=>{let l=r.target.closest('[data-action="toggle-conditional"]');if(l){let c=l.getAttribute("data-familiar-index"),u=l.getAttribute("data-conditional-id");if(c!==null){let d=parseInt(c,10);An(d,u||void 0)}}})}function ta(){let e=document.getElementById("rosterList");e&&e.addEventListener("click",i=>{let r=i.target,s=r.getAttribute("data-action"),l=r.getAttribute("data-id"),c=l!==null?parseInt(l):-1;if(!(c<0))switch(s){case"edit":ra(c);break;case"delete":confirm("Delete this familiar?")&&Pt(c);break;case"toggle":Ot(c);break}});let t=document.querySelector('[data-action="export-roster"]');t&&t.addEventListener("click",va);let n=document.querySelector('[data-action="import-roster"]');n&&n.addEventListener("click",ya),document.querySelectorAll('[data-action="free-wave"]').forEach(i=>{i.addEventListener("click",()=>{let r=i.getAttribute("data-wave");if(r){let s=parseInt(r);s>=1&&s<=3&&ba(s)}})});let o=document.querySelector('[data-action="free-all-waves"]');o&&o.addEventListener("click",Ia);let a=document.querySelector('[data-action="delete-all-roster"]');a&&a.addEventListener("click",Ca),na()}function na(){let e=()=>{let o=R.getCurrentRoster(h.getState());L(o)},t=document.getElementById("rosterSearchInput");if(t){let o;t.addEventListener("input",()=>{clearTimeout(o),o=window.setTimeout(e,200)})}["rosterFilterRank","rosterFilterElement","rosterFilterType","rosterFilterWave","rosterSortBy"].forEach(o=>{let a=document.getElementById(o);a&&a.addEventListener("change",e)})}function oa(){["dice1","dice2","dice3"].forEach(e=>{let t=document.getElementById(e);t&&t.addEventListener("change",N)})}function aa(){document.querySelectorAll('[data-action="load-wave"]').forEach(e=>{e.addEventListener("click",()=>{let t=e.getAttribute("data-wave");if(t){let n=parseInt(t);n>=1&&n<=3&&Ge(n)}})}),document.querySelectorAll('[data-action="save-wave"]').forEach(e=>{e.addEventListener("click",()=>{let t=e.getAttribute("data-wave");if(t){let n=parseInt(t);n>=1&&n<=3&&Ht(n)}})})}function ia(){document.addEventListener("keydown",e=>{e.key==="Escape"&&sa()})}function Vn(e){let t=document.getElementById("familiarModal"),n=document.getElementById("familiarModalTitle"),o=document.getElementById("familiarEditSlot");if(!t||!o)return;let i=h.getState().calcFamiliars[e];o.value=String(e),n&&(n.textContent=i&&i.rank?"Edit Familiar":"Add Familiar");let r=document.getElementById("familiarEditName");r&&(r.value=i?.name||""),ot?.setValue(i?.rank||""),Gt?.setValue(i?.element||"None"),Kt?.setValue(i?.type||"Human"),i?.conditional&&W?W.setSelected(i.conditional):W?.clear(),Qo(),Ut?.clear(),t.style.display="flex"}function ra(e){let n=R.getCurrentRoster(h.getState()).find(r=>r.id===e);if(!n)return;h.setState({editingFamiliarId:e});let o=document.getElementById("rosterName"),a=document.getElementById("rosterCancelBtn"),i=document.getElementById("rosterAddBtn");o&&(o.value=n.name),se?.setValue(n.rank),pe?.setValue(n.element),he?.setValue(n.type),a&&(a.style.display="inline-block"),i&&(i.textContent="Save Changes"),n.conditional&&T?T.setSelected(n.conditional):T?.clear(),o?.focus()}function sa(){document.querySelectorAll(".modal").forEach(e=>{e.style.display="none"})}function Zt(){document.querySelectorAll('[data-action="close-modal"]').forEach(e=>{e.addEventListener("click",()=>{let t=e.closest(".modal");t&&(t.style.display="none")})}),document.querySelectorAll(".modal").forEach(e=>{e.addEventListener("click",t=>{t.target===e&&(e.style.display="none")})})}function la(){W=Le({searchInputId:"modalCondSearch",resultsContainerId:"modalCondResults",variantSectionId:"bonusVariantSection",variantPillsId:"bonusVariantPills",triggerNameId:"selectedTriggerName",displayId:"selectedCondDisplay",getRank:()=>ot?.getValue()||null,prePatchCheckboxId:"modalPrePatch"});let e=document.getElementById("modalCondSearch");e&&e.addEventListener("input",()=>{W?.search()});let t=document.getElementById("modalCondResults");t&&t.addEventListener("click",r=>{let l=r.target.closest(".trigger-result-item");if(l){let c=parseInt(l.getAttribute("data-trigger-index")||"-1");c>=0&&W?.selectTrigger(c)}});let n=document.getElementById("bonusVariantPills");n&&n.addEventListener("click",r=>{let l=r.target.closest(".bonus-pill");if(l){let c=parseInt(l.getAttribute("data-variant-index")||"-1");c>=0&&W?.selectVariant(c)}});let o=document.querySelector('[data-action="clear-trigger"]');o&&o.addEventListener("click",()=>{W?.clear()});let a=document.getElementById("selectedCondDisplay");a&&a.addEventListener("click",r=>{r.target.getAttribute("data-action")==="remove-conditional"&&W?.clear()});let i=document.getElementById("modalPrePatch");i&&i.addEventListener("change",()=>{W?.search()})}function ca(){T=Le({searchInputId:"rosterConditionalSearch",resultsContainerId:"rosterConditionalResults",variantSectionId:"rosterBonusVariantSection",variantPillsId:"rosterBonusVariantPills",triggerNameId:"rosterSelectedTriggerName",displayId:"selectedConditionalDisplay",getRank:()=>se?.getValue()||null,prePatchCheckboxId:"prePatchFam"});let e=document.getElementById("rosterConditionalSearch");e&&e.addEventListener("input",()=>{T?.search()});let t=document.getElementById("rosterConditionalResults");t&&t.addEventListener("click",r=>{let l=r.target.closest(".trigger-result-item");if(l){let c=parseInt(l.getAttribute("data-trigger-index")||"-1");c>=0&&T?.selectTrigger(c)}});let n=document.getElementById("rosterBonusVariantPills");n&&n.addEventListener("click",r=>{let l=r.target.closest(".bonus-pill");if(l){let c=parseInt(l.getAttribute("data-variant-index")||"-1");c>=0&&T?.selectVariant(c)}});let o=document.querySelector('[data-action="clear-roster-trigger"]');o&&o.addEventListener("click",()=>{T?.clear()});let a=document.getElementById("selectedConditionalDisplay");a&&a.addEventListener("click",r=>{r.target.getAttribute("data-action")==="remove-conditional"&&T?.clear()});let i=document.getElementById("prePatchFam");i&&i.addEventListener("change",()=>{T?.search()})}function da(){let e=document.querySelector('[data-action="save-familiar"]');e&&e.addEventListener("click",ua)}function ua(){let e=document.getElementById("familiarEditSlot"),t=document.getElementById("familiarEditName");if(!e)return;let n=parseInt(e.value),o=ot?.getValue()||"";if(!o){alert("Please select a rank");return}let a={name:t?.value||`Familiar ${n+1}`,rank:o,element:Gt?.getValue()||"None",type:Kt?.getValue()||"Human",conditional:W?.getSelected()??null};Me(n,a);let i=document.getElementById("familiarModal");i&&(i.style.display="none"),W?.clear()}function ma(){let e=document.getElementById("rosterAddBtn");e&&e.addEventListener("click",fa);let t=document.getElementById("rosterCancelBtn");t&&t.addEventListener("click",ga)}function fa(){let t=document.getElementById("rosterName")?.value?.trim();if(!t){alert("Please enter a familiar name");return}let n=se?.getValue()||"Common",o=pe?.getValue()||"None",a=he?.getValue()||"Human",i=h.getState(),r=i.editingFamiliarId;if(r){let s=i.characters.findIndex(d=>d.id===i.currentCharacterId);if(s===-1)return;let l=[...i.characters],c=[...l[s].roster],u=c.findIndex(d=>d.id===r);u!==-1&&(c[u]={...c[u],name:t,rank:n,element:o,type:a,conditional:T?.getSelected()??null},l[s].roster=c,h.setState({characters:l,editingFamiliarId:null}),k(),L(c))}else $e({name:t,rank:n,element:o,type:a,conditional:T?.getSelected()??null});qn()}function ga(){h.setState({editingFamiliarId:null}),qn()}function qn(){let e=document.getElementById("rosterName"),t=document.getElementById("rosterCancelBtn"),n=document.getElementById("rosterAddBtn");e&&(e.value=""),t&&(t.style.display="none"),n&&(n.textContent="Add to Collection"),se?.setValue("Common"),pe?.setValue("None"),he?.setValue("Human"),T?.clear()}function pa(){let e=document.querySelector('[data-action="open-bonus-modal"]');e&&e.addEventListener("click",()=>{let a=document.getElementById("bonusItemModal");if(a){a.style.display="flex";let i=document.getElementById("bonusItemSearch");i&&(i.focus(),Ye(""))}});let t=document.getElementById("bonusItemSearch");t&&t.addEventListener("input",a=>{let i=a.target.value;Ye(i)});let n=document.getElementById("bonusItemSearchResults");n&&n.addEventListener("click",a=>{let r=a.target.closest(".bonus-item-result");if(r){let s=parseInt(r.getAttribute("data-item-index")||"-1"),l=r.getAttribute("data-query")||"";s>=0&&Hn(s,l)}});let o=document.getElementById("bonusItemsList");o&&o.addEventListener("click",a=>{let i=a.target;if(i.getAttribute("data-action")==="delete-bonus-item"){let r=parseInt(i.getAttribute("data-index")||"-1");r>=0&&Nn(r)}})}function ha(){let e=document.querySelector('[data-action="calculate-passing-combos"]');e&&e.addEventListener("click",()=>{Pn()});let t=document.querySelector('[data-action="toggle-reroll-help"]');t&&t.addEventListener("click",()=>{let n=document.getElementById("rerollHelpContent");n&&(n.style.display=n.style.display==="none"?"block":"none")})}function va(){let e=R.getCurrentRoster(h.getState());if(e.length===0){x("No familiars to export");return}let t=e.map(({id:r,...s})=>s),n=JSON.stringify(t,null,2),o=new Blob([n],{type:"application/json"}),a=URL.createObjectURL(o),i=document.createElement("a");i.href=a,i.download="familiar-collection.json",i.click(),URL.revokeObjectURL(a),x(`Exported ${e.length} familiars`)}function ya(){let e=document.createElement("input");e.type="file",e.accept=".json",e.addEventListener("change",async()=>{let t=e.files?.[0];if(t)try{let n=await t.text(),o=JSON.parse(n);if(!Array.isArray(o)){x("Invalid file format");return}let a=0;for(let i of o)i.name&&i.rank&&i.type&&($e({name:i.name,rank:i.rank,element:i.element||"None",type:i.type,conditional:i.conditional||null,wave:i.wave||null,disabled:i.disabled||!1}),a++);x(`Imported ${a} familiars`)}catch{x("Failed to import file")}}),e.click()}function ba(e){let t=h.getState(),n=t.characters.findIndex(i=>i.id===t.currentCharacterId);if(n<0)return;let o=[...t.characters],a=o[n].roster.map(i=>i.wave===e?{...i,wave:null}:i);o[n]={...o[n],roster:a},h.setState({characters:o}),k(),L(a),x(`Freed Wave ${e} familiars`)}function Ia(){let e=h.getState(),t=e.characters.findIndex(a=>a.id===e.currentCharacterId);if(t<0)return;let n=[...e.characters],o=n[t].roster.map(a=>({...a,wave:null}));n[t]={...n[t],roster:o},h.setState({characters:n}),k(),L(o),x("Freed all wave assignments")}function Ca(){let e=R.getCurrentRoster(h.getState());if(e.length===0){x("No familiars to delete");return}if(!confirm(`Delete all ${e.length} familiars? This cannot be undone.`))return;let t=h.getState(),n=t.characters.findIndex(a=>a.id===t.currentCharacterId);if(n<0)return;let o=[...t.characters];o[n]={...o[n],roster:[]},h.setState({characters:o}),k(),L([]),x("Deleted all familiars")}function wa(e){switch(e){case"overall":return{title:"Best Overall (Expected Value)",content:`
          <p>This strategy finds the lineup with the <strong>highest average score</strong> across all possible dice combinations.</p>
          <h4>How it works:</h4>
          <ul>
            <li>For each lineup, we evaluate the score using the average dice values based on familiar ranks</li>
            <li>Common = d3 (avg 2), Rare = d4 (avg 2.5), Epic = d5 (avg 3), Unique/Legendary = d6 (avg 3.5)</li>
          </ul>
          <h4>Example:</h4>
          <p>A lineup with 3 Legendary familiars would be evaluated with dice [3.5, 3.5, 3.5], giving an expected dice sum of 10.5.</p>
          <h4>Best for:</h4>
          <p>General use - gives the most reliable performance estimate over many runs.</p>
        `};case"low":return{title:"Best for Low Rolls",content:`
          <p>This strategy finds the lineup that performs <strong>best in the worst-case scenario</strong> - when all dice roll 1.</p>
          <h4>How it works:</h4>
          <ul>
            <li>Every lineup is evaluated with dice values [1, 1, 1]</li>
            <li>The lineup with the highest score under these conditions wins</li>
          </ul>
          <h4>Example:</h4>
          <p>With dice [1, 1, 1], dice sum = 3. A lineup with strong flat bonuses (+10 flat) would score: (3 + 10) = 13.</p>
          <h4>Best for:</h4>
          <p>Risk-averse players who want to minimize bad outcomes. Prioritizes lineups with unconditional bonuses or bonuses that trigger on low rolls.</p>
        `};case"high":return{title:"Best for High Rolls",content:`
          <p>This strategy finds the lineup that performs <strong>best when you roll maximum</strong> on all dice.</p>
          <h4>How it works:</h4>
          <ul>
            <li>Each familiar's max dice is based on rank: Common=3, Rare=4, Epic=5, Unique/Legendary=6</li>
            <li>The lineup is evaluated with these maximum values</li>
          </ul>
          <h4>Example:</h4>
          <p>3 Legendary familiars would be evaluated with [6, 6, 6], giving dice sum = 18. With a 1.5x multiplier, score = 18 \xD7 1.5 = 27.</p>
          <h4>Best for:</h4>
          <p>Maximizing peak potential. Good for lineups with multiplier bonuses that scale with high dice values.</p>
        `};case"median":return{title:"Median Score",content:`
          <p>This strategy finds the lineup with the <strong>highest 50th percentile score</strong> - the score you'll exceed half the time.</p>
          <h4>How it works:</h4>
          <ul>
            <li>For each lineup, we calculate scores for ALL possible dice combinations</li>
            <li>We sort all scores and pick the middle value (median)</li>
            <li>The lineup with the highest median wins</li>
          </ul>
          <h4>Example:</h4>
          <p>If a lineup has 216 possible outcomes (6\xD76\xD76), the median is the average of the 108th and 109th highest scores.</p>
          <h4>Best for:</h4>
          <p>Understanding "typical" performance. More representative than average when there are extreme outliers.</p>
        `};case"floorGuarantee":return{title:"Floor Guarantee",content:`
          <p>This strategy finds the lineup where <strong>80% or more of outcomes meet a minimum threshold</strong>.</p>
          <h4>How it works:</h4>
          <ul>
            <li>For each lineup, calculate all possible scores</li>
            <li>The floor is set at 80% of the average score</li>
            <li>Count what percentage of outcomes meet or exceed this floor</li>
            <li>Among lineups where 80%+ meet the floor, pick the one with the highest floor value</li>
          </ul>
          <h4>Example:</h4>
          <p>If average score is 50, the floor is 40. If 85% of dice combinations score \u226540, this lineup qualifies. The display shows "85% above 40".</p>
          <h4>Best for:</h4>
          <p>Consistency-focused players who want predictable minimum performance.</p>
        `};case"balanced":return{title:"Balanced (Weighted Average)",content:`
          <p>This strategy uses a <strong>weighted combination</strong> of low, average, and high roll scores.</p>
          <h4>How it works:</h4>
          <ul>
            <li>Calculate score with low rolls [1,1,1] \u2192 weight 25%</li>
            <li>Calculate score with average dice \u2192 weight 50%</li>
            <li>Calculate score with max dice \u2192 weight 25%</li>
            <li>Final score = (0.25 \xD7 low) + (0.50 \xD7 avg) + (0.25 \xD7 high)</li>
          </ul>
          <h4>Example:</h4>
          <p>Low=10, Avg=25, High=40 \u2192 Balanced = (0.25\xD710) + (0.50\xD725) + (0.25\xD740) = 2.5 + 12.5 + 10 = 25</p>
          <h4>Best for:</h4>
          <p>All-around performance. Balances worst-case protection with upside potential.</p>
        `};case"diceIndependent":return{title:"No Dice Dependency",content:`
          <p>This strategy finds lineups where <strong>all bonuses activate regardless of dice rolls</strong>.</p>
          <h4>How it works:</h4>
          <ul>
            <li>Only considers familiars with conditionals that don't depend on dice values</li>
            <li>Excludes conditions like "if dice sum \u2265 X" or "if any die rolls 6"</li>
            <li>Includes conditions based on lineup composition (element/type matching)</li>
            <li>Prioritizes lineups with more guaranteed active bonuses</li>
          </ul>
          <h4>Valid conditional types:</h4>
          <ul>
            <li>"If a Fire familiar is in lineup" - activates based on element</li>
            <li>"If all familiars have same type" - activates based on composition</li>
            <li>Always-active bonuses with no conditions</li>
          </ul>
          <h4>Best for:</h4>
          <p>Consistent, reliable lineups where you know exactly what bonuses you'll get every time. No luck required!</p>
        `};default:return{title:"Strategy",content:"<p>No information available.</p>"}}}function Ea(e){let{title:t,content:n}=wa(e),o=document.getElementById("strategyHelpModal");o&&o.remove();let a=`
    <div id="strategyHelpModal" class="strategy-modal-overlay">
      <div class="strategy-modal">
        <div class="strategy-modal-header">
          <h3>${t}</h3>
          <button class="strategy-modal-close">&times;</button>
        </div>
        <div class="strategy-modal-content">
          ${n}
        </div>
      </div>
    </div>
  `;document.body.insertAdjacentHTML("beforeend",a);let i=document.getElementById("strategyHelpModal");i&&i.addEventListener("click",r=>{let s=r.target;(s.classList.contains("strategy-modal-overlay")||s.classList.contains("strategy-modal-close"))&&i.remove()})}function Sa(){let e=document.getElementById("scannerHelpModal");e&&e.remove(),document.body.insertAdjacentHTML("beforeend",`
    <div id="scannerHelpModal" class="strategy-modal-overlay">
      <div class="strategy-modal">
        <div class="strategy-modal-header">
          <h3>Scan Familiar Card</h3>
          <button class="strategy-modal-close">&times;</button>
        </div>
        <div class="strategy-modal-content">
          <p>The scanner automatically extracts familiar details from a screenshot of a familiar card.</p>

          <h4>How to Use</h4>
          <ul>
            <li><strong>Click</strong> the upload area to select an image file</li>
            <li><strong>Drag & drop</strong> an image onto the upload area</li>
            <li><strong>Paste (Ctrl+V)</strong> a screenshot from your clipboard while on this tab</li>
          </ul>

          <h4>What Gets Extracted</h4>
          <ul>
            <li><strong>Rank</strong> - Detected from the card border color</li>
            <li><strong>Element</strong> - Detected from the element icon</li>
            <li><strong>Type</strong> - Detected from the type icon</li>
            <li><strong>Name</strong> - Extracted using OCR (may need manual correction)</li>
            <li><strong>Conditional</strong> - Matched from extracted text</li>
          </ul>

          <h4>Tips</h4>
          <ul>
            <li>Use clear, uncropped screenshots for best results</li>
            <li>The conditional matcher prioritizes bonuses matching the detected rank</li>
            <li>Review and correct any fields before adding to your collection</li>
          </ul>
        </div>
      </div>
    </div>
  `);let n=document.getElementById("scannerHelpModal");n&&n.addEventListener("click",o=>{let a=o.target;(a.classList.contains("strategy-modal-overlay")||a.classList.contains("strategy-modal-close"))&&n.remove()})}function xa(){document.addEventListener("click",i=>{let r=i.target;if(r.classList.contains("strategy-help-btn")){let s=r.getAttribute("data-strategy");s&&Ea(s)}if(r.classList.contains("section-help-btn")&&r.getAttribute("data-help")==="scanner"&&Sa(),r.classList.contains("strategy-calculate-btn")){let s=r.getAttribute("data-strategy");s&&Ta(s)}if(r.getAttribute("data-action")==="assign-wave"){let s=r.getAttribute("data-lineup-id"),l=r.getAttribute("data-wave");if(s&&l){let c=parseInt(l);ka(s,c)}}});let e=document.getElementById("filterElement"),t=document.getElementById("filterType"),n=document.getElementById("filterRequireMatch"),o=document.getElementById("filterRequireMatchAny");e&&e.addEventListener("change",()=>{Qe(),ge()}),t&&t.addEventListener("change",()=>{Qe(),ge()}),n&&n.addEventListener("change",()=>{Qe(),ge()}),o&&o.addEventListener("change",()=>{Qe(),ge()}),ge();let a=document.getElementById("findCustomDiceLineups");a&&a.addEventListener("click",Ba)}function Ba(){let e=document.getElementById("customDiceResults");if(!e)return;let t=document.getElementById("customDice1"),n=document.getElementById("customDice2"),o=document.getElementById("customDice3");if(!t||!n||!o)return;let a=[parseInt(t.value)||1,parseInt(n.value)||1,parseInt(o.value)||1];for(let m=0;m<3;m++)if(a[m]<1||a[m]>6){e.innerHTML='<div class="no-results">Dice values must be between 1 and 6</div>';return}let i=h.getState(),r=i.characters.find(m=>m.id===i.currentCharacterId);if(!r){e.innerHTML='<div class="no-results">No character selected</div>';return}let s=r.roster.filter(m=>!m.disabled&&!m.wave&&!Y(m.conditional));if(s.length<3){e.innerHTML='<div class="no-results">Need at least 3 available familiars</div>';return}let l=s.map(m=>({id:m.id,name:m.name,rank:m.rank,element:m.element,type:m.type,conditional:m.conditional||null})),u=Ve(l,3).filter(m=>{let y=m.map(v=>v.conditional?.name).filter(v=>!!v);return new Set(y).size===y.length}),d=[];for(let m of u){let y=m.map(E=>X(E.rank)),v=[[0,1,2],[0,2,1],[1,0,2],[1,2,0],[2,0,1],[2,1,0]],I=null,C=null;for(let E of v){let D=[a[E[0]],a[E[1]],a[E[2]]],B=!0;for(let M=0;M<3;M++)if(D[M]>y[M]){B=!1;break}if(B){let M=O(m,[],D);(!I||M.score>I.score)&&(I=M,C=D)}}I&&C&&d.push({familiars:m,evaluation:I,diceAssignment:C})}d.sort((m,y)=>y.evaluation.score-m.evaluation.score);let f=[],g=new Set;for(let m of d){let y=m.familiars.map(I=>I.id??I.name);if(!y.some(I=>g.has(I))&&(f.push(m),y.forEach(I=>g.add(I)),f.length>=2))break}if(f.length===0){e.innerHTML='<div class="no-results">No lineups can achieve these dice values. Try lower values or add higher-rank familiars.</div>';return}let p=`[${a.join(", ")}]`;e.innerHTML=f.map((m,y)=>{let v={familiars:m.familiars,score:m.evaluation.score,diceSum:m.evaluation.diceSum,totalFlat:m.evaluation.totalFlat,totalMult:m.evaluation.totalMult,activeBonusNames:m.evaluation.activeBonusNames,familiarBreakdown:m.evaluation.familiarBreakdown,scoreLabel:p,testDice:m.diceAssignment};return Un("custom",`Result ${y+1}`,`Dice: ${p}`,v)}).join("")}function ka(e,t){let n=Jt.get(e);if(!n||n.length!==3){x("Lineup not found");return}let o=h.getState(),a=o.characters.findIndex(d=>d.id===o.currentCharacterId);if(a<0)return;let i=o.characters[a].roster.filter(d=>d.wave===t);if(i.length>0&&!confirm(`Wave ${t} already has ${i.length} familiar(s) assigned. Replace them?`))return;let r=[...o.characters],s=[...r[a].roster];i.length>0&&(s=s.map(d=>d.wave===t?{...d,wave:null}:d));let l=new Set;for(let d of n){let f=s.findIndex((g,p)=>!l.has(p)&&!g.wave&&(d.id?g.id===d.id:g.name===d.name&&g.rank===d.rank&&g.element===d.element&&g.type===d.type));f!==-1&&(s[f]={...s[f],wave:t},l.add(f))}if(l.size===0){x("Familiars not found in roster or already assigned");return}r[a]={...r[a],roster:s};let c={...o.savedWaves,[t]:[...n]};h.setState({characters:r,savedWaves:c}),k(),L(s),ge(),x(`Assigned ${l.size} familiars to Wave ${t}`);let u=document.querySelector('[data-page="calculator"]');u&&u.click(),Ge(t)}var Re=null,jt="",_t="";function Qe(){Re=null,jt="",_t=""}function Ma(){let e=document.getElementById("filterElement"),t=document.getElementById("filterType"),n=document.getElementById("filterRequireMatch"),o=document.getElementById("filterRequireMatchAny");return{element:e?.value||"",type:t?.value||"",requireMatch:n?.checked||!1,requireMatchAny:o?.checked||!1}}var Jt=new Map,zn=0,jn=[{key:"overall",configKey:"overall",title:"Best Overall",subtitle:"Expected average across all dice outcomes",renderType:"overall"},{key:"lowRolls",configKey:"lowRolls",title:"Best for Low Rolls",subtitle:"Optimal when dice roll minimum values",renderType:"low"},{key:"highRolls",configKey:"highRolls",title:"Best for High Rolls",subtitle:"Optimal when dice roll maximum values",renderType:"high"},{key:"diceIndependent",configKey:"diceIndependent",title:"No Dice Dependency",subtitle:"Bonuses activate regardless of dice rolls",renderType:"diceIndependent"},{key:"median",configKey:"median",title:"Median Score",subtitle:"50th percentile of all outcomes",renderType:"median"},{key:"floorGuarantee",configKey:"floorGuarantee",title:"Floor Guarantee",subtitle:"80%+ of rolls meet minimum",renderType:"floorGuarantee"},{key:"balanced",configKey:"balanced",title:"Balanced",subtitle:"Weighted 25% low + 50% avg + 25% high",renderType:"balanced"}];function $a(e){return e.filter(t=>!t.disabled&&!t.wave&&!Y(t.conditional)).map(t=>`${t.id}-${t.name}-${t.conditional?.id||"none"}`).join("|")}function _n(){let e=h.getState(),t=R.getCurrentRoster(e),n=t.filter(l=>!l.disabled&&!l.wave&&!Y(l.conditional));if(n.length<3)return null;let o=Ma(),a=`${o.element}|${o.type}|${o.requireMatch}|${o.requireMatchAny}`,i=$a(t);if(Re&&jt===i&&_t===a)return Re;let r=n.map(l=>({id:l.id,name:l.name,rank:l.rank,element:l.element,type:l.type,conditional:l.conditional})),s=Ve(r,3);return o.requireMatch&&(o.element||o.type)&&(s=s.filter(l=>l.some(c=>{let u=!o.element||c.element===o.element,d=!o.type||c.type===o.type;return o.element&&o.type?u&&d:o.element&&u||o.type&&d}))),o.requireMatchAny&&(o.element||o.type)&&(s=s.filter(l=>{let c=!o.element||l.some(d=>d.element===o.element),u=!o.type||l.some(d=>d.type===o.type);return c&&u})),s=s.filter(l=>{let c=l.map(u=>u.conditional?.name).filter(u=>!!u);return new Set(c).size===c.length}),Re=s,jt=i,_t=a,Re}function ge(){let e=document.getElementById("optimizerResults");if(!e)return;let t=h.getState(),o=R.getCurrentRoster(t).filter(s=>!s.disabled&&!s.wave&&!Y(s.conditional)),a=t.configOptimizer;if(o.length<3){e.innerHTML='<div class="optimizer-empty">Need at least 3 available familiars to optimize (not disabled, assigned to a wave, or bugged).</div>';return}let r=_n()?.length||0;if(r===0){e.innerHTML='<div class="optimizer-empty">No lineups match the current filters. Try adjusting the element/type filters.</div>';return}e.innerHTML=La(a,r)}function La(e,t){let n=jn.filter(a=>e.strategies[a.configKey]?.enabled!==!1);if(n.length===0)return'<div class="optimizer-empty">No strategies enabled. Check config/optimizer-config.json</div>';let o=`<div class="optimizer-info">Ready to analyze ${t.toLocaleString()} combinations</div>`;o+='<div class="optimizer-results-grid">';for(let a of n)o+=Ra(a);return o+="</div>",o}function Ra(e){return`
    <div class="lineup-card strategy-card-empty" id="strategy-card-${e.key}">
      <div class="lineup-card-header">
        <div class="lineup-card-titles">
          <h3 class="lineup-card-title">${e.title}</h3>
          <span class="lineup-card-subtitle">${e.subtitle}</span>
        </div>
        <button class="strategy-help-btn" data-strategy="${e.renderType}" title="How is this calculated?">?</button>
      </div>
      <div class="strategy-card-action">
        <button class="strategy-calculate-btn" data-strategy="${e.key}">Calculate</button>
      </div>
    </div>
  `}function Ta(e){let t=document.getElementById(`strategy-card-${e}`);if(!t)return;let n=_n();if(!n||n.length===0){x("Need at least 3 enabled familiars to optimize.");return}let o=t.querySelector(".strategy-calculate-btn");o&&(o.disabled=!0,o.textContent="Calculating...");let r=h.getState().configOptimizer.strategies[e]?.ignoredConditionalIds??[],s=Aa(n,r);setTimeout(()=>{try{let l=null,c=jn.find(u=>u.key===e);if(!c)return;switch(e){case"overall":l=qe(s,[],"overall");break;case"lowRolls":l=qe(s,[],"lowRolls");break;case"highRolls":l=qe(s,[],"highRolls");break;case"diceIndependent":l=En(s,[]);break;case"median":l=In(s,[]);break;case"floorGuarantee":l=Cn(s,[]);break;case"balanced":l=wn(s,[]);break}l?e==="balanced"?t.outerHTML=Fa(l):t.outerHTML=Un(c.renderType,c.title,c.subtitle,l):t.innerHTML=`
          <div class="lineup-card-header">
            <div class="lineup-card-titles">
              <h3 class="lineup-card-title">${c.title}</h3>
              <span class="lineup-card-subtitle">No valid lineup found</span>
            </div>
          </div>
        `}catch(l){console.error(`Error calculating ${e}:`,l),o&&(o.disabled=!1,o.textContent="Retry")}},10)}function Aa(e,t){if(t.length===0)return e;let n=new Set(t.map(o=>String(o)));return e.map(o=>o.map(a=>a.conditional?.id&&n.has(a.conditional.id)?{...a,conditional:null}:a))}function Un(e,t,n,o){let a=`lineup-${++zn}`;Jt.set(a,o.familiars);let i=o.familiars.map(r=>{let s=`rank-${r.rank.toLowerCase()}`,l=`element-${r.element.toLowerCase()}`,c=r.conditional?.id!==void 0?`data-conditional-id="${r.conditional.id}"`:"",u="";if(r.conditional){let d=[];r.conditional.flatBonus!==0&&d.push(r.conditional.flatBonus>=0?`+${r.conditional.flatBonus}`:`${r.conditional.flatBonus}`),r.conditional.multiplierBonus!==0&&r.conditional.multiplierBonus!==1&&d.push(`x${r.conditional.multiplierBonus}`),d.length>0&&(u=`[${d.join(", ")}]`)}return`
      <div class="lineup-familiar ${s} ${l}" ${c}>
        <div class="lineup-familiar-name">${w(r.name)}</div>
        <div class="lineup-familiar-meta">
          <span class="rank-text ${s}">${r.rank}</span>
          <span class="element-text ${l}">${r.element}</span>
          <span class="type-text">${r.type}</span>
        </div>
        ${r.conditional?`<div class="lineup-familiar-bonus">${w(r.conditional.name)}</div>${u?`<div class="bonus-values">${u}</div>`:""}`:""}
      </div>
    `}).join("");return`
    <div class="lineup-card">
      <div class="lineup-card-header">
        <div class="lineup-card-titles">
          <h3 class="lineup-card-title">${t}</h3>
          <span class="lineup-card-subtitle">${n}</span>
        </div>
        <button class="strategy-help-btn" data-strategy="${e}" title="How is this calculated?">?</button>
      </div>
      <div class="lineup-score-display">
        <div class="score-main">
          <span class="score-number">${o.score.toLocaleString()}</span>
          <span class="score-label-text">Score</span>
        </div>
        <div class="score-details">
          <span class="score-dice">${o.scoreLabel}</span>
        </div>
      </div>
      <div class="lineup-familiars-grid">
        ${i}
      </div>
      <div class="lineup-card-actions">
        <div class="lineup-wave-buttons">
          <span class="wave-label">Assign:</span>
          <button class="wave-btn" data-action="assign-wave" data-lineup-id="${a}" data-wave="1">W1</button>
          <button class="wave-btn" data-action="assign-wave" data-lineup-id="${a}" data-wave="2">W2</button>
          <button class="wave-btn" data-action="assign-wave" data-lineup-id="${a}" data-wave="3">W3</button>
        </div>
      </div>
    </div>
  `}function Fa(e){let t=`lineup-${++zn}`;Jt.set(t,e.familiars);let n=e.familiars.map(i=>{let r=`rank-${i.rank.toLowerCase()}`,s=`element-${i.element.toLowerCase()}`,l=i.conditional?.id!==void 0?`data-conditional-id="${i.conditional.id}"`:"",c="";if(i.conditional){let u=[];i.conditional.flatBonus!==0&&u.push(i.conditional.flatBonus>=0?`+${i.conditional.flatBonus}`:`${i.conditional.flatBonus}`),i.conditional.multiplierBonus!==0&&i.conditional.multiplierBonus!==1&&u.push(`x${i.conditional.multiplierBonus}`),u.length>0&&(c=`[${u.join(", ")}]`)}return`
      <div class="lineup-familiar ${r} ${s}" ${l}>
        <div class="lineup-familiar-name">${w(i.name)}</div>
        <div class="lineup-familiar-meta">
          <span class="rank-text ${r}">${i.rank}</span>
          <span class="element-text ${s}">${i.element}</span>
          <span class="type-text">${i.type}</span>
        </div>
        ${i.conditional?`<div class="lineup-familiar-bonus">${w(i.conditional.name)}</div>${c?`<div class="bonus-values">${c}</div>`:""}`:""}
      </div>
    `}).join(""),o=e.balancedComponents,a=o?`<div class="balanced-breakdown">
        <div class="breakdown-item">
          <span class="breakdown-label">Low (25%)</span>
          <span class="breakdown-value">${o.lowRollScore}</span>
        </div>
        <div class="breakdown-item">
          <span class="breakdown-label">Avg (50%)</span>
          <span class="breakdown-value">${o.avgScore}</span>
        </div>
        <div class="breakdown-item">
          <span class="breakdown-label">High (25%)</span>
          <span class="breakdown-value">${o.highRollScore}</span>
        </div>
      </div>`:"";return`
    <div class="lineup-card">
      <div class="lineup-card-header">
        <div class="lineup-card-titles">
          <h3 class="lineup-card-title">Balanced</h3>
          <span class="lineup-card-subtitle">Weighted 25% low + 50% avg + 25% high</span>
        </div>
        <button class="strategy-help-btn" data-strategy="balanced" title="How is this calculated?">?</button>
      </div>
      <div class="lineup-score-display">
        <div class="score-main">
          <span class="score-number">${e.score.toLocaleString()}</span>
          <span class="score-label-text">Score</span>
        </div>
        <div class="score-details">
          <span class="score-dice">${e.scoreLabel}</span>
        </div>
      </div>
      ${a}
      <div class="lineup-familiars-grid">
        ${n}
      </div>
      <div class="lineup-card-actions">
        <div class="lineup-wave-buttons">
          <span class="wave-label">Assign:</span>
          <button class="wave-btn" data-action="assign-wave" data-lineup-id="${t}" data-wave="1">W1</button>
          <button class="wave-btn" data-action="assign-wave" data-lineup-id="${t}" data-wave="2">W2</button>
          <button class="wave-btn" data-action="assign-wave" data-lineup-id="${t}" data-wave="3">W3</button>
        </div>
      </div>
    </div>
  `}var nt=null;function Da(){let e=document.getElementById("scannerDropZone"),t=document.getElementById("cardImageInput");!e||!t||(e.addEventListener("click",()=>{t.click()}),t.addEventListener("change",()=>{let n=t.files?.[0];n&&(qt(n),t.value="")}),e.addEventListener("dragover",n=>{n.preventDefault(),n.stopPropagation(),e.classList.add("drag-over")}),e.addEventListener("dragleave",n=>{n.preventDefault(),n.stopPropagation(),e.classList.remove("drag-over")}),e.addEventListener("drop",n=>{n.preventDefault(),n.stopPropagation(),e.classList.remove("drag-over");let o=n.dataTransfer?.files[0];o&&o.type.startsWith("image/")&&qt(o)}),document.addEventListener("paste",n=>{let o=document.getElementById("page-roster");if(!o||!o.classList.contains("active"))return;let a=n.target;if(a.tagName==="INPUT"||a.tagName==="TEXTAREA")return;let i=n.clipboardData?.items;if(i){for(let r of i)if(r.type.startsWith("image/")){n.preventDefault();let s=r.getAsFile();s&&qt(s);break}}}),Ha(),Va())}async function qt(e){let t=document.getElementById("scannerPreview"),n=document.getElementById("scannerStatus");if(!(!t||!n)){t.style.display="block",n.textContent="Processing...",n.className="scanner-status processing";try{let o=await pn(e,a=>{n.textContent=a});nt=o,n.textContent="Scan complete!",n.className="scanner-status success",Na(o)}catch(o){console.error("Scan failed:",o),n.textContent=o instanceof Error?o.message:"Scan failed",n.className="scanner-status error",nt=null}}}function Na(e){let t=document.getElementById("extractionModal");if(!t)return;let n=document.getElementById("extractedCardPreview");n&&e.croppedImage&&(n.src=e.croppedImage);let o=document.getElementById("extractedName");o&&(o.value=e.name||"");let a=document.getElementById("extractedRank"),i=document.getElementById("rankConfidence");a&&(a.value=e.rank.rank),i&&(ue()?(i.textContent=`${Math.round(e.rank.confidence)}%`,i.className=`confidence ${Te(e.rank.confidence/100)}`):i.style.display="none");let r=document.getElementById("extractedElement"),s=document.getElementById("elementConfidence");r&&(r.value=e.element.element),s&&(ue()?(s.textContent=`${Math.round(e.element.confidence)}%`,s.className=`confidence ${Te(e.element.confidence/100)}`):s.style.display="none");let l=document.getElementById("extractedType"),c=document.getElementById("typeConfidence");l&&(l.value=e.type.type),c&&(ue()?(c.textContent=`${Math.round(e.type.confidence)}%`,c.className=`confidence ${Te(e.type.confidence/100)}`):c.style.display="none");let u=document.getElementById("extractedConditionalText");if(u&&(u.textContent=e.conditional.rawText||"(No text detected)"),U&&(U.clear(),e.conditional.confidence>35&&e.conditional.matched)){let f=e.rank.rank,m=Ct(e.conditional.rawText,10).find(y=>y.id&&(y.rarity||y.rank)===f)||e.conditional.matched;m&&U.setSelected(m)}let d=document.getElementById("conditionalConfidence");d&&(ue()&&e.conditional.matched?(d.textContent=`${Math.round(e.conditional.confidence)}%`,d.className=`confidence ${Te(e.conditional.confidence/100)}`,d.style.display=""):d.style.display="none"),Wa(e),t.style.display="flex"}function Te(e){return e>=.8?"high":e>=.5?"medium":"low"}function Ha(){U=Le({searchInputId:"extractedCondSearch",resultsContainerId:"extractedCondResults",variantSectionId:"extractedBonusVariantSection",variantPillsId:"extractedBonusVariantPills",triggerNameId:"extractedSelectedTriggerName",displayId:"extractedSelectedCondDisplay",getRank:()=>document.getElementById("extractedRank")?.value||null});let e=document.getElementById("extractedCondSearch");e&&e.addEventListener("input",()=>{U?.search()});let t=document.getElementById("extractedCondResults");t&&t.addEventListener("click",s=>{let c=s.target.closest(".trigger-result-item");if(c){let u=parseInt(c.getAttribute("data-trigger-index")||"0",10);U?.selectTrigger(u)}});let n=document.getElementById("extractedBonusVariantPills");n&&n.addEventListener("click",s=>{let c=s.target.closest(".bonus-pill");if(c){let u=parseInt(c.getAttribute("data-variant-index")||"0",10);U?.selectVariant(u)}});let o=document.querySelector('[data-action="clear-extracted-trigger"]');o&&o.addEventListener("click",()=>{U?.clear()});let a=document.getElementById("extractedSelectedCondDisplay");a&&a.addEventListener("click",s=>{s.target.getAttribute("data-action")==="remove-conditional"&&U?.clear()});let i=document.querySelector('[data-action="add-from-scan"]');i&&i.addEventListener("click",Pa);let r=document.querySelector('[data-action="fill-form"]');r&&r.addEventListener("click",Oa)}function Pa(){let e=document.getElementById("extractedName"),t=document.getElementById("extractedRank"),n=document.getElementById("extractedElement"),o=document.getElementById("extractedType"),a=e?.value?.trim();if(!a){x("Please enter a familiar name");return}let i=U?.getSelected()||null;$e({name:a,rank:t?.value||"Common",element:n?.value||"None",type:o?.value||"Human",conditional:i,wave:null,disabled:!1});let r=document.getElementById("extractionModal");r&&(r.style.display="none");let s=document.getElementById("scannerPreview");s&&(s.style.display="none"),x(`Added ${a} to collection`),nt=null}function Oa(){let e=document.getElementById("extractedName"),t=document.getElementById("extractedRank"),n=document.getElementById("extractedElement"),o=document.getElementById("extractedType"),a=document.getElementById("rosterName");a&&e&&(a.value=e.value),t&&se&&se.setValue(t.value),n&&pe&&pe.setValue(n.value),o&&he&&he.setValue(o.value);let i=U?.getSelected();i&&T&&T.setSelected(i);let r=document.getElementById("extractionModal");r&&(r.style.display="none");let s=document.getElementById("scannerPreview");s&&(s.style.display="none"),a&&a.focus(),x("Form filled with scan data"),nt=null}function Wa(e){let t=document.getElementById("scannerDebugSection");if(!t)return;if(!ue()){t.style.display="none";return}t.style.display="";let n=Et(),o=document.getElementById("debugElementExtracted");if(o&&e.element.iconData){let s=o.getContext("2d");s&&(s.clearRect(0,0,64,64),s.drawImage(e.element.iconData.canvas,0,0,64,64))}let a=document.getElementById("debugTypeExtracted");if(a&&e.type.iconData){let s=a.getContext("2d");s&&(s.clearRect(0,0,64,64),s.drawImage(e.type.iconData.canvas,0,0,64,64))}let i=document.getElementById("debugElementReferences");if(i&&e.element.allScores){i.innerHTML="";let s=Object.entries(e.element.allScores).sort((l,c)=>c[1]-l[1]);for(let[l,c]of s){let u=n.elements[l];if(!u)continue;let d=document.createElement("div");d.className="debug-ref-item"+(l===e.element.element?" best-match":"");let f=document.createElement("canvas");f.width=48,f.height=48;let g=f.getContext("2d");g&&g.drawImage(u,0,0,48,48);let p=document.createElement("span");p.className="ref-name",p.textContent=l;let m=document.createElement("span");m.className="ref-score "+Gn(c),m.textContent=`${Math.round(c)}%`,d.appendChild(f),d.appendChild(p),d.appendChild(m),i.appendChild(d)}}Yn(e.type.allScores,e.type.type,n);let r=Kn();Zn(r)}function Gn(e){return e>=70?"high":e>=40?"medium":"low"}var et=null;function Va(){let e=document.getElementById("tuneBgTolerance"),t=document.getElementById("tuneBgTolValue");e&&e.addEventListener("input",()=>{t&&(t.textContent=e.value),tt()});let n=document.getElementById("tuneMorphology"),o=document.getElementById("tuneMorphValue");n&&n.addEventListener("input",()=>{o&&(o.textContent=n.value),tt()});let a=document.getElementById("tuneAdaptiveBg");a&&a.addEventListener("change",()=>{tt()});let i=["tuneMaskWeight","tuneHuWeight","tuneEdgeWeight","tuneColorWeight"],r=["tuneMaskValue","tuneHuValue","tuneEdgeValue","tuneColorValue"];i.forEach((s,l)=>{let c=document.getElementById(s),u=document.getElementById(r[l]);c&&c.addEventListener("input",()=>{u&&(u.textContent=c.value),qa(),tt()})})}function tt(){et!==null&&window.clearTimeout(et),et=window.setTimeout(()=>{et=null,za()},300)}function Kn(){let e=document.getElementById("tuneBgTolerance"),t=document.getElementById("tuneMorphology"),n=document.getElementById("tuneAdaptiveBg"),o=document.getElementById("tuneMaskWeight"),a=document.getElementById("tuneHuWeight"),i=document.getElementById("tuneEdgeWeight"),r=document.getElementById("tuneColorWeight");return{backgroundTolerance:parseInt(e?.value||"45",10),morphologyKernel:parseInt(t?.value||"1",10),useAdaptiveBackground:n?.checked??!0,maskWeight:parseInt(o?.value||"40",10)/100,huWeight:parseInt(a?.value||"25",10)/100,edgeWeight:parseInt(i?.value||"20",10)/100,colorWeight:parseInt(r?.value||"15",10)/100}}function qa(){let e=document.getElementById("tuneMaskWeight"),t=document.getElementById("tuneHuWeight"),n=document.getElementById("tuneEdgeWeight"),o=document.getElementById("tuneColorWeight"),a=document.getElementById("tuneWeightTotal");if(!a)return;let i=parseInt(e?.value||"40",10)+parseInt(t?.value||"25",10)+parseInt(n?.value||"20",10)+parseInt(o?.value||"15",10);a.textContent=`${i}%`,i!==100?a.classList.add("warning"):a.classList.remove("warning")}function za(){if(!yt()){console.log("No icon data to recalculate");return}let t=Et();if(!t||Object.keys(t.types).length===0){console.log("No reference images");return}let n=Kn();console.log("Recalculating with params:",n);let o=ht(n);if(!o){console.log("Recalculation returned null");return}let a=Object.entries(o.allScores).sort((c,u)=>u[1]-c[1]),i=a[0]?.[0]||"",r=a[0]?.[1]||0,s=document.getElementById("extractedType"),l=document.getElementById("typeConfidence");s&&(s.value=i),l&&(l.textContent=`${Math.round(r)}%`,l.className=`confidence ${Te(r/100)}`),Yn(o.allScores,i,t),Zn(n)}function Yn(e,t,n){let o=document.getElementById("debugTypeReferences");if(!o)return;o.innerHTML="";let a=Object.entries(e).sort((i,r)=>r[1]-i[1]);for(let[i,r]of a){let s=n.types[i];if(!s)continue;let l=document.createElement("div");l.className="debug-ref-item"+(i===t?" best-match":"");let c=document.createElement("canvas");c.width=48,c.height=48;let u=c.getContext("2d");u&&u.drawImage(s,0,0,48,48);let d=document.createElement("span");d.className="ref-name",d.textContent=i;let f=document.createElement("span");f.className="ref-score "+Gn(r),f.textContent=`${Math.round(r)}%`;let g=vt()[i];if(g){let p=document.createElement("span");p.className="ref-details",p.textContent=`M:${Math.round(g.mask*100)} H:${Math.round(g.hu*100)} E:${Math.round(g.edge*100)} C:${Math.round(g.color*100)}`,l.appendChild(c),l.appendChild(d),l.appendChild(f),l.appendChild(p)}else l.appendChild(c),l.appendChild(d),l.appendChild(f);o.appendChild(l)}}function Zn(e){let t=bt(e);if(!t)return;let n=32,o=document.getElementById("debugTypeMaskRaw");o&&zt(o,t.rawMask,n);let a=document.getElementById("debugTypeMaskCleaned");a&&zt(a,t.cleanedMask,n);let i=document.getElementById("debugTypeEdges");i&&zt(i,t.edges,n)}function zt(e,t,n){let o=e.getContext("2d");if(!o)return;let a=0;for(let c=0;c<t.length;c++)t[c]>a&&(a=t[c]);let i=a<=1?255:1,r=o.createImageData(n,n);for(let c=0;c<t.length;c++){let u=t[c]*i,d=c*4;r.data[d]=u,r.data[d+1]=u,r.data[d+2]=u,r.data[d+3]=255}let s=document.createElement("canvas");s.width=n,s.height=n,s.getContext("2d").putImageData(r,0,0),o.imageSmoothingEnabled=!1,o.clearRect(0,0,e.width,e.height),o.drawImage(s,0,0,e.width,e.height)}var ne=["None","Fire","Poison","Lightning","Ice","Dark","Holy"],oe=["Human","Beast","Plant","Aquatic","Fairy","Reptile","Devil","Undead","Machine"],ja={N:"None",F:"Fire",P:"Poison",L:"Lightning",I:"Ice",D:"Dark",H:"Holy"},at=[],ae=new Set,le=new Map,S="both";async function Xn(){try{at=(await(await fetch("familiars.json")).json()).filter(n=>n.Level>=185&&n.Level<295).map(n=>({...n,element:n.ElementName||ja[n.ElementCode]||"None",type:n.TypeName})),_a(),ve()}catch(e){console.error("Failed to load familiars:",e);let t=document.getElementById("famfinderStats");t&&(t.innerHTML='<p style="color: #ff6666;">Error loading familiars data</p>')}}function _a(){let e=document.getElementById("famfinderClearIgnored");e&&e.addEventListener("click",Ya),document.querySelectorAll(".famfinder-mode-btn").forEach(t=>{t.addEventListener("click",()=>{let n=t.getAttribute("data-mode");n&&Ua(n)})})}function Ua(e){S=e,document.querySelectorAll(".famfinder-mode-btn").forEach(t=>{t.classList.toggle("active",t.getAttribute("data-mode")===e)}),le.clear(),ve()}function Ga(e){ae.add(e);for(let[t,n]of le.entries())n===e&&le.delete(t);ve()}function Ka(e){ae.delete(e),ve()}function Ya(){ae.clear(),le.clear(),ve()}function Jn(e,t,n){let o=`${e}-${t}`;S==="types"&&(o=e),S==="elements"&&(o=t),le.set(o,n),ve(),eo()}function Qn(e,t){return at.filter(n=>ae.has(n.FamiliarId)?!1:S==="types"?n.type===e:(S==="elements"||n.type===e)&&n.element===t).sort((n,o)=>o.Level-n.Level)}function Za(e,t,n){let o=Qn(e,t);if(o.length<=1)return;let a=document.getElementById("famfinderAlternativesModal"),i=document.getElementById("famfinderAlternativesInfo"),r=document.getElementById("famfinderAlternativesList");!a||!i||!r||(S==="types"?i.textContent=`${o.length} familiars with ${e} type:`:S==="elements"?i.textContent=`${o.length} familiars with ${t} element:`:i.textContent=`${o.length} familiars with ${e} type and ${t} element:`,r.innerHTML=o.map(s=>`
    <div class="famfinder-alternative-item element-${s.element.toLowerCase()} ${s.FamiliarId===n?"selected":""}"
         data-id="${s.FamiliarId}" data-type="${e}" data-element="${t}">
      <div class="famfinder-alternative-info">
        <div class="famfinder-alternative-name">${s.MobName}</div>
        <div class="famfinder-alternative-details">Level ${s.Level} | ${s.type} | ${s.element}</div>
      </div>
      <div class="famfinder-alternative-action">
        <button class="select-btn" data-action="select-alternative">Select</button>
      </div>
    </div>
  `).join(""),r.querySelectorAll('[data-action="select-alternative"]').forEach(s=>{s.addEventListener("click",l=>{l.stopPropagation();let c=l.target.closest(".famfinder-alternative-item");if(!c)return;let u=parseInt(c.getAttribute("data-id")||"0"),d=c.getAttribute("data-type")||"",f=c.getAttribute("data-element")||"";Jn(d,f,u)})}),r.querySelectorAll(".famfinder-alternative-item").forEach(s=>{s.addEventListener("click",()=>{let l=parseInt(s.getAttribute("data-id")||"0"),c=s.getAttribute("data-type")||"",u=s.getAttribute("data-element")||"";Jn(c,u,l)})}),a.style.display="flex")}function eo(){let e=document.getElementById("famfinderAlternativesModal");e&&(e.style.display="none")}function ve(){try{let e=at.filter(i=>!ae.has(i.FamiliarId)),t=S!=="elements"?new Set(oe):new Set,n=S!=="types"?new Set(ne):new Set,o=[],a=new Set;for(let[i,r]of le.entries()){let s=e.find(l=>l.FamiliarId===r);s&&(a.add(s.FamiliarId),o.push({...s,newType:t.has(s.type),newElement:n.has(s.element)}),t.delete(s.type),n.delete(s.element))}for(;t.size>0||n.size>0;){let i=null,r=0;for(let s of e){if(a.has(s.FamiliarId))continue;let l=0;S!=="elements"&&t.has(s.type)&&l++,S!=="types"&&n.has(s.element)&&l++,(l>r||l===r&&i&&s.Level>i.Level)&&(r=l,i=s)}if(!i||r===0)break;a.add(i.FamiliarId),o.push({...i,newType:t.has(i.type),newElement:n.has(i.element)}),t.delete(i.type),n.delete(i.element)}Ja(),Xa(e.length,o.length,t,n),Qa(t,n),ei(o)}catch(e){console.error("Error in findMinimumFamiliars:",e)}}function Ja(){let e=document.getElementById("famfinderIgnored"),t=document.getElementById("famfinderIgnoredList");if(!(!e||!t))if(ae.size>0){e.style.display="block";let n=at.filter(o=>ae.has(o.FamiliarId));t.innerHTML=n.map(o=>`<span class="famfinder-ignored-tag" data-id="${o.FamiliarId}">${o.MobName} \u2715</span>`).join(""),t.querySelectorAll(".famfinder-ignored-tag").forEach(o=>{o.addEventListener("click",()=>{let a=parseInt(o.getAttribute("data-id")||"0");Ka(a)})})}else e.style.display="none"}function Xa(e,t,n,o){let a=document.getElementById("famfinderStats");if(!a)return;let i=oe.filter(c=>!n.has(c)),r=ne.filter(c=>!o.has(c)),s="";S==="both"?s=`${oe.length} types + ${ne.length} elements = 16 total`:S==="types"?s=`${oe.length} types`:s=`${ne.length} elements`;let l="";S!=="elements"&&(l+=`<p><strong>Types covered:</strong> ${i.length}/${oe.length}</p>`),S!=="types"&&(l+=`<p><strong>Elements covered:</strong> ${r.length}/${ne.length}</p>`),a.innerHTML=`
    <p><strong>Total level 185-294 familiars:</strong> ${e} (${ae.size} ignored)</p>
    <p><strong>Need to cover:</strong> ${s}</p>
    <p><strong>Minimum familiars needed:</strong> ${t}</p>
    ${l}
  `}function Qa(e,t){let n=document.getElementById("famfinderCoverage");if(!n)return;let o=oe.filter(r=>!e.has(r)),a=ne.filter(r=>!t.has(r)),i="";S!=="elements"&&(i+=`
      <div class="famfinder-coverage-section">
        <h4>Types (${o.length}/${oe.length})</h4>
        ${oe.map(r=>`<span class="famfinder-tag ${e.has(r)?"missing":"covered"}">${r}</span>`).join("")}
      </div>
    `),S!=="types"&&(i+=`
      <div class="famfinder-coverage-section">
        <h4>Elements (${a.length}/${ne.length})</h4>
        ${ne.map(r=>`<span class="famfinder-tag ${t.has(r)?"missing":"covered"}">${r}</span>`).join("")}
      </div>
    `),n.innerHTML=i}function ei(e){let t=document.getElementById("famfinderResults");t&&(t.innerHTML=e.map((n,o)=>{let a=[];S!=="elements"&&n.newType&&a.push(n.type),S!=="types"&&n.newElement&&a.push(n.element);let i=Qn(n.type,n.element),r=i.length>1,s=`${n.type}-${n.element}`;S==="types"&&(s=n.type),S==="elements"&&(s=n.element);let l=le.has(s);return`
      <div class="famfinder-card element-${n.element.toLowerCase()}" data-id="${n.FamiliarId}">
        <div class="famfinder-card-header">
          <span class="famfinder-card-name">${n.MobName}</span>
          <span class="famfinder-card-index">#${o+1}</span>
        </div>
        <div class="famfinder-card-info">Level ${n.Level} | ${n.type} | ${n.element}</div>
        <div class="famfinder-card-covers">New coverage: ${a.join(", ")}</div>
        ${r?`<div class="famfinder-alternatives-count">${i.length} alternatives available${l?" (locked)":""}</div>`:""}
        <div class="famfinder-card-actions">
          ${r?`<button class="famfinder-btn alternatives" data-action="show-alternatives" data-type="${n.type}" data-element="${n.element}" data-current="${n.FamiliarId}">Choose</button>`:""}
          <button class="famfinder-btn ignore" data-action="ignore" data-id="${n.FamiliarId}">Ignore</button>
        </div>
      </div>
    `}).join(""),t.querySelectorAll('[data-action="show-alternatives"]').forEach(n=>{n.addEventListener("click",o=>{o.stopPropagation();let a=o.target.getAttribute("data-type")||"",i=o.target.getAttribute("data-element")||"",r=parseInt(o.target.getAttribute("data-current")||"0");Za(a,i,r)})}),t.querySelectorAll('[data-action="ignore"]').forEach(n=>{n.addEventListener("click",o=>{o.stopPropagation();let a=parseInt(o.target.getAttribute("data-id")||"0");Ga(a)})}))}window.closeFamfinderModal=eo;function ti(){let e=new URLSearchParams(window.location.search).has("is_dev"),t=h.getState(),n=t.configConditionalBonuses?.bonuses||[];if(e&&(console.group("[migrateConditional] Starting migration"),console.log("Config bonuses loaded:",n.length),console.log("Characters in state:",t.characters.length),console.log("SavedWaves:",t.savedWaves),console.log("CalcFamiliars:",t.calcFamiliars)),n.length===0){e&&(console.warn("[migrateConditional] No config bonuses found, aborting"),console.groupEnd());return}let o=new Map;for(let c of n)c.id&&o.set(c.id,c);e&&(console.log("[migrateConditional] Bonus lookup map size:",o.size),console.log("[migrateConditional] Bonus IDs in config:",[...o.keys()]));let a=(c,u)=>{if(!c)return c;if(!c.id)return e&&console.warn(`[${u}] Conditional has no ID, cannot migrate:`,c),c;let d=o.get(c.id);if(!d)return e&&console.warn(`[${u}] ID "${c.id}" not found in config bonuses!`),c;if(c.condition!==d.condition||c.multiplierBonus!==d.multiplierBonus||c.flatBonus!==d.flatBonus||c.name!==d.name||c.rarity!==d.rarity||c.color!==d.color){let g={...d};return e&&(console.group(`[${u}]`),console.log("Stored:",c),console.log("Config:",d),console.log("%c-> MIGRATING (syncing all fields)","color: orange; font-weight: bold"),console.groupEnd()),g}return c},i=!1,r=t.characters.map(c=>{let u=c.roster.map((d,f)=>{let g=a(d.conditional,`char:${c.name}/fam:${d.name}[${f}]`);return g!==d.conditional?(i=!0,{...d,conditional:g}):d});return{...c,roster:u}}),s={...t.savedWaves};for(let c of[1,2,3]){let u=s[c];s[c]=u.map((d,f)=>{if(!d)return d;let g=a(d.conditional,`wave:${c}/slot:${f}/${d.name}`);return g!==d.conditional?(i=!0,{...d,conditional:g}):d})}let l=t.calcFamiliars.map((c,u)=>{if(!c)return c;let d=a(c.conditional,`calc:slot${u}/${c.name}`);return d!==c.conditional?(i=!0,{...c,conditional:d}):c});i?(e&&console.log("[migrateConditional] Applying migrations to store..."),console.log("Migrated conditional strings to match current config"),h.setState({characters:r,savedWaves:s,calcFamiliars:l}),k(),e&&console.log("[migrateConditional] Saved to localStorage")):e&&console.log("[migrateConditional] No migrations needed"),e&&console.groupEnd()}async function to(){new URLSearchParams(window.location.search).has("is_dev")&&(console.group("[init] IMMEDIATE localStorage snapshot (before anything runs)"),console.log("savedWaves:",localStorage.getItem("savedWaves")),console.log("characters:",localStorage.getItem("characters")),console.groupEnd()),console.log("Mystic Frontier Calculator v2.0.0 initializing...");try{Qt(),await tn(),ti(),en(),Yt(),Zt(),gn().catch(n=>{console.warn("Scanner initialization failed:",n)});let t=xt();ni(),t&&Xn().catch(n=>{console.warn("Familiar finder initialization failed:",n)}),N(),console.log("Mystic Frontier Calculator ready!")}catch(t){console.error("Initialization failed:",t)}}function ni(){let e=h.getState();ee(e.calcFamiliars);let t=R.getCurrentRoster(e);L(t),it(),si()}function it(){let e=document.getElementById("characterSelector");if(!e)return;let t=h.getState(),n=t.characters,o=t.currentCharacterId,a=n.map(i=>`<option value="${i.id}" ${i.id===o?"selected":""}>${li(i.name)}</option>`).join("");e.innerHTML=`
    <select id="characterSelect">
      ${a}
    </select>
    <button class="char-btn" data-action="add-character">+</button>
    <button class="char-btn" data-action="rename-character">Rename</button>
    ${n.length>1?'<button class="char-btn delete" data-action="delete-character">Delete</button>':""}
  `,oi()}function oi(){document.querySelector('[data-action="add-character"]')?.addEventListener("click",ai),document.querySelector('[data-action="rename-character"]')?.addEventListener("click",ii),document.querySelector('[data-action="delete-character"]')?.addEventListener("click",ri);let e=document.getElementById("characterSelect");e&&e.addEventListener("change",t=>{let n=parseInt(t.target.value);isNaN(n)||Wt(n)})}function ai(){let e=prompt("Enter character name:");if(!e||!e.trim())return;let t=h.getState(),n={id:Date.now(),name:e.trim(),roster:[]};h.setState({characters:[...t.characters,n],currentCharacterId:n.id}),it(),L([])}function ii(){let e=h.getState(),t=e.characters.find(a=>a.id===e.currentCharacterId);if(!t)return;let n=prompt("Enter new name:",t.name);if(!n||!n.trim())return;let o=e.characters.map(a=>a.id===e.currentCharacterId?{...a,name:n.trim()}:a);h.setState({characters:o}),it()}function ri(){let e=h.getState();if(e.characters.length<=1){alert("Cannot delete the last character");return}let t=e.characters.find(a=>a.id===e.currentCharacterId);if(!t||!confirm(`Delete character "${t.name}" and all their familiars?`))return;let n=e.characters.filter(a=>a.id!==e.currentCharacterId);h.setState({characters:n,currentCharacterId:n[0].id}),it();let o=R.getCurrentRoster(h.getState());L(o)}function si(){re();for(let e=0;e<3;e++){let t=document.getElementById(`dice${e+1}`);t&&(t.value="1")}}function li(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",to):to();window.app={store:h};
