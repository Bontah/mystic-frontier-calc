<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mystic Frontier Calculator</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>Mystic Frontier Calculator</h1>

  <!-- Navigation Bar -->
  <nav class="top-nav">
    <button class="nav-btn active" data-page="calculator">Calculator</button>
    <button class="nav-btn" data-page="roster">My Roster</button>
    <button class="nav-btn" data-page="info">Additional Information</button>
    <button class="nav-btn" data-page="howtouse">How to Use</button>
  </nav>

  <!-- Calculator Page -->
  <div id="page-calculator" class="page active">
    <!-- Familiars & Waves Section -->
    <div class="section">
      <div class="familiars-header">
        <h2>Familiars <span id="currentWaveLabel"></span></h2>
        <button class="reset-all-btn" data-action="reset-all">Reset All</button>
      </div>
      <div class="familiars-layout">
        <!-- Left: Stacked Familiars -->
        <div class="familiars-stack" id="familiarsGrid">
          <!-- Populated by JavaScript -->
        </div>
        <!-- Right: Waves -->
        <div class="waves-panel">
          <div class="waves-header">Expedition Waves</div>
          <div class="wave-buttons">
            <button class="wave-tab wave-1">Wave 1</button>
            <button class="wave-tab wave-2">Wave 2</button>
            <button class="wave-tab wave-3">Wave 3</button>
          </div>
          <button class="save-wave-btn" data-action="save-wave">Save to Wave</button>
        </div>
      </div>
    </div>

    <!-- Two-Column Layout: Difficulty+Dice | Bonus Items -->
    <div class="calc-row">
      <!-- Left Column: Difficulty + Dice stacked -->
      <div class="calc-left">
        <!-- Difficulty Section -->
        <div class="section">
          <h2>Difficulty</h2>
          <div class="difficulty-input">
            <label for="difficulty" style="margin: 0;">Target to beat:</label>
            <input type="number" id="difficulty" value="50" min="0">
          </div>
        </div>

        <!-- Dice Section -->
        <div class="section">
          <h2>Dice</h2>
          <div class="dice-row">
            <div class="dice-group">
              <label>Dice 1</label>
              <select id="dice1">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
              </select>
            </div>
            <div class="dice-group">
              <label>Dice 2</label>
              <select id="dice2">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
              </select>
            </div>
            <div class="dice-group">
              <label>Dice 3</label>
              <select id="dice3">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
              </select>
            </div>
          </div>
          <!-- Active Conditionals Summary -->
          <div class="conditionals-summary">
            <div class="conditionals-summary-header">Active Conditionals</div>
            <div id="waveSummaryConditionals" class="conditionals-summary-list">
              <!-- Populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Bonus Items -->
      <div class="calc-right">
        <div class="section">
          <h2>Bonus Items</h2>
          <div class="config-section-title">Item Library</div>
          <div class="config-search">
            <input type="text" id="bonusItemSearch" placeholder="Search items...">
          </div>
          <div id="bonusItemSearchResults" class="config-results" style="display: none;"></div>
          <div class="config-section-title">Active Items</div>
          <div id="bonusItemsList" class="bonus-list">
            <!-- Populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>

    <!-- Results Section -->
    <div class="results">
      <div class="result-main">
        <div class="result-left">
          <div class="final-result" id="finalResult">3</div>
          <div class="result-status" id="resultStatus">FAIL</div>
          <div class="difference" id="difference">Failed by 47</div>
        </div>
        <div class="result-right">
          <div class="result-stat">
            <span class="stat-label">Flat Bonus</span>
            <span class="stat-value" id="flatBonus">+0</span>
          </div>
          <div class="result-stat">
            <span class="stat-label">Dice Sum</span>
            <span class="stat-value" id="diceSum">3</span>
          </div>
          <div class="result-stat">
            <span class="stat-label">Multiplier</span>
            <span class="stat-value" id="totalMult">×1.0</span>
          </div>
        </div>
      </div>
      <div id="activeBonusesDisplay" class="active-bonuses-display"></div>

      <!-- Reroll Suggestions -->
      <div id="rerollSection" class="reroll-section" style="display: none;">
        <div class="reroll-title">Reroll Suggestions</div>
        <div id="rerollSuggestions" class="reroll-suggestions">
          <!-- Populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <!-- My Roster Page -->
  <div id="page-roster" class="page">
    <!-- Character Selector -->
    <div class="character-selector-wrapper">
      <label>Character:</label>
      <div id="characterSelector" class="character-selector"></div>
    </div>

    <!-- Familiar Roster Section -->
    <div class="section">
      <h2>My Familiar Roster</h2>
      <p class="section-description">Add all the familiars you own. The optimizer will suggest the best lineups from your roster.</p>

      <div class="roster-add-form">
        <div class="roster-inputs">
          <input type="text" id="rosterName" placeholder="Familiar name...">
          <div id="rosterRankContainer"></div>
          <div id="rosterElementContainer"></div>
          <div id="rosterTypeContainer"></div>
          <button id="rosterAddBtn" class="add-btn" data-action="add-to-roster">Add to Roster</button>
          <button id="rosterCancelBtn" class="cancel-btn" data-action="cancel-edit" style="display: none;">Cancel</button>
        </div>
        <div class="roster-conditional-search">
          <div class="conditional-label-row">
            <label>Conditional Bonus</label>
            <label class="prepatch-label"><input type="checkbox" id="prePatchFam"> Pre-patch</label>
          </div>
          <input type="text" id="rosterConditionalSearch" placeholder="Search condition (e.g. Fire, Beast, dice)...">
          <div id="rosterConditionalResults" class="config-results" style="display: none;"></div>
          <!-- Step 2: Select bonus variant -->
          <div id="rosterBonusVariantSection" class="bonus-variant-section" style="display: none;">
            <div class="bonus-variant-header">
              <span class="variant-trigger-name" id="rosterSelectedTriggerName"></span>
              <button class="change-trigger-btn" data-action="clear-roster-trigger">Change</button>
            </div>
            <div class="bonus-variant-pills" id="rosterBonusVariantPills"></div>
          </div>
          <div id="selectedConditionalDisplay" class="selected-conditional" style="display: none;"></div>
        </div>
      </div>

      <div id="rosterList" class="roster-list"></div>
      <div class="roster-stats">
        <span id="rosterCount">0 familiars in roster</span>
        <div class="roster-actions">
          <button class="free-wave-btn wave-1" data-action="free-wave" data-wave="1">Free W1</button>
          <button class="free-wave-btn wave-2" data-action="free-wave" data-wave="2">Free W2</button>
          <button class="free-wave-btn wave-3" data-action="free-wave" data-wave="3">Free W3</button>
          <button class="free-all-btn" data-action="free-all-waves">Free All</button>
          <button class="export-btn" data-action="export-roster">Export</button>
          <button class="import-btn" data-action="import-roster">Import</button>
          <input type="file" id="importFile" accept=".json" style="display: none;">
        </div>
      </div>
    </div>

    <!-- Image Scanner Section -->
    <div class="section">
      <h2>Scan Familiar Card</h2>
      <p class="section-description">Upload a screenshot of a familiar card to automatically extract its details.</p>

      <div class="scanner-upload-area" id="scannerDropZone">
        <input type="file" id="cardImageInput" accept="image/*" style="display: none;">
        <div class="upload-prompt">
          <span class="upload-icon">+</span>
          <span>Click, drag, or paste (Ctrl+V) a card screenshot</span>
        </div>
      </div>

      <div id="scannerPreview" class="scanner-preview" style="display: none;">
        <canvas id="scannerCanvas"></canvas>
        <div class="scanner-status" id="scannerStatus">Processing...</div>
      </div>
    </div>

    <!-- Lineup Optimizer Section -->
    <div class="section">
      <h2>Lineup Optimizer</h2>

      <div class="optimizer-filters">
        <div class="filter-group">
          <label>Expedition Element</label>
          <select id="filterElement">
            <option value="">Any Element</option>
            <option value="Fire">Fire</option>
            <option value="Ice">Ice</option>
            <option value="Lightning">Lightning</option>
            <option value="Poison">Poison</option>
            <option value="Dark">Dark</option>
            <option value="Holy">Holy</option>
            <option value="None">None (Non-elemental)</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Expedition Type</label>
          <select id="filterType">
            <option value="">Any Type</option>
            <option value="Human">Human</option>
            <option value="Beast">Beast</option>
            <option value="Plant">Plant</option>
            <option value="Aquatic">Aquatic</option>
            <option value="Fairy">Fairy</option>
            <option value="Reptile">Reptile</option>
            <option value="Devil">Devil</option>
            <option value="Undead">Undead</option>
            <option value="Machine">Machine</option>
          </select>
        </div>
        <div class="filter-mode">
          <label>
            <input type="checkbox" id="filterRequireMatch">
            Require at least one matching familiar
          </label>
        </div>
      </div>

      <div class="optimizer-help">
        <div class="help-toggle" data-action="toggle-optimizer-help">
          How does scoring work? <span class="help-icon">?</span>
        </div>
        <div id="optimizerHelpContent" class="optimizer-help-content" style="display: none;">
          <div class="help-item">
            <strong>Best Overall (Expected Value):</strong>
            <p>Calculates the average score across ALL possible dice roll combinations. This gives the most reliable performance estimate.</p>
          </div>
          <div class="help-item">
            <strong>Best for Low Rolls (1-1-1):</strong>
            <p>Shows which lineup performs best when you roll the minimum on all dice - the worst case scenario.</p>
          </div>
          <div class="help-item">
            <strong>Best for High Rolls (Max):</strong>
            <p>Shows which lineup performs best when you roll the maximum on all dice - the best case scenario.</p>
          </div>
        </div>
      </div>

      <div class="optimizer-controls">
        <button class="optimize-btn" data-action="run-optimizer">Find Best Lineups</button>
      </div>
      <div id="optimizerResults" class="optimizer-results"></div>
    </div>
  </div>

  <!-- Additional Information Page -->
  <div id="page-info" class="page">
    <div class="section">
      <h2>Additional Information</h2>
      <p class="section-description">Information about how the calculator works and game mechanics.</p>

      <div class="info-block">
        <h3>Familiar Ranks & Dice</h3>
        <ul>
          <li><strong>Common:</strong> d3 (rolls 1-3)</li>
          <li><strong>Rare:</strong> d4 (rolls 1-4)</li>
          <li><strong>Epic:</strong> d5 (rolls 1-5)</li>
          <li><strong>Unique:</strong> d6 (rolls 1-6)</li>
          <li><strong>Legendary:</strong> d6 (rolls 1-6)</li>
        </ul>
      </div>

      <div class="info-block">
        <h3>How Calculation Works</h3>
        <ol>
          <li>Roll dice for each familiar (based on their rank)</li>
          <li>Sum all dice values</li>
          <li>Add flat bonuses from items and active conditionals</li>
          <li>Apply multipliers (if any)</li>
          <li>Round down to get final result</li>
          <li>Compare to difficulty target</li>
        </ol>
      </div>

      <div class="info-block">
        <h3>Conditional Bonuses</h3>
        <p>Conditional bonuses activate based on specific conditions like dice values, familiar types, or elements. Each familiar in your roster can have one conditional bonus attached to them.</p>
      </div>

      <div class="info-block">
        <h3>Possible Rewards</h3>
        <p>Community-compiled list of GMS v265 Mystic Frontier rewards:</p>
        <p><a href="https://pastebin.com/kRbUSbt9" target="_blank" class="external-link">GMS v265 - Mystic Frontier Possible Rewards</a></p>
      </div>
    </div>
  </div>

  <!-- How to Use Page -->
  <div id="page-howtouse" class="page">
    <div class="section">
      <h2>How to Use</h2>

      <div class="howtouse-section">
        <h3>Welcome</h3>
        <p>Mystic Frontier Calculator helps you calculate expedition scores, manage your familiar roster, and find the best lineup combinations for your expeditions.</p>
      </div>

      <div class="howtouse-section">
        <h3>Calculator</h3>
        <p>The Calculator tab lets you simulate expedition outcomes:</p>
        <ul>
          <li>Select 3 familiars from your roster (or enter manually)</li>
          <li>Each familiar contributes their dice roll based on rank</li>
          <li>Adjust the dice values to see different outcomes</li>
          <li>Add bonus items for extra flat bonuses or multipliers</li>
          <li>The total score is calculated as: (Dice Sum + Flat Bonuses) x Multipliers</li>
        </ul>
      </div>

      <div class="howtouse-section">
        <h3>My Roster</h3>
        <p>Build and manage your familiar collection:</p>
        <ul>
          <li>Add familiars manually by filling out the form</li>
          <li>Or use the <strong>Image Scanner</strong> to automatically extract familiar data from screenshots</li>
          <li>Assign familiars to expedition waves for quick access</li>
          <li>Use the <strong>Lineup Optimizer</strong> to find the best combinations</li>
        </ul>
      </div>

      <div class="howtouse-section">
        <h3>Image Scanner</h3>
        <p>Quickly add familiars by scanning screenshots of your familiar cards:</p>
        <ol>
          <li>In-game, open your familiar's details screen</li>
          <li>Take a screenshot that shows the familiar card clearly</li>
          <li>Upload the screenshot to the Image Scanner</li>
          <li>The scanner will extract: Name, Rank, Element, Type, and Conditional bonus</li>
          <li>Review and adjust the extracted data if needed</li>
          <li>Click "Add to Roster" to add directly, or "Fill Form" to review first</li>
        </ol>
        <p><strong>How to capture the card in-game:</strong></p>
        <div class="howtouse-images">
          <div class="howtouse-image">
            <img src="examples/howtouse_1.png" alt="Step 1: In-game capture">
            <span>Step 1</span>
          </div>
          <div class="howtouse-image">
            <img src="examples/howtouse_2.png" alt="Step 2: In-game capture">
            <span>Step 2</span>
          </div>
        </div>
      </div>

      <div class="howtouse-section">
        <h3>Lineup Optimizer</h3>
        <p>Find the best familiar combinations from your roster:</p>
        <ul>
          <li>The optimizer analyzes all possible 3-familiar combinations</li>
          <li>Shows best lineups for: Expected value, Low rolls (1-1-1), and High rolls</li>
          <li>Filter by element or type if your expedition requires specific ones</li>
          <li>Click "Use This Lineup" to load the familiars into the calculator</li>
        </ul>
      </div>

      <div class="howtouse-section">
        <h3>Additional Information</h3>
        <p>The Additional Information tab contains reference tables for:</p>
        <ul>
          <li>Familiar ranks and their dice types</li>
          <li>How the score calculation works</li>
          <li>Conditional bonus information</li>
          <li>Links to community resources</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Extraction Results Modal -->
  <div id="extractionModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>Extracted Familiar Data</h3>
      <div class="modal-preview">
        <img id="extractedCardPreview" src="" alt="Card Preview">
      </div>
      <div class="extraction-results">
        <div class="extraction-row">
          <label>Name</label>
          <input type="text" id="extractedName" placeholder="Familiar name">
        </div>
        <div class="extraction-row">
          <label>Rank</label>
          <select id="extractedRank">
            <option value="Common">Common (d3)</option>
            <option value="Rare">Rare (d4)</option>
            <option value="Epic">Epic (d5)</option>
            <option value="Unique">Unique (d6)</option>
            <option value="Legendary">Legendary (d6)</option>
          </select>
          <span class="confidence" id="rankConfidence"></span>
        </div>
        <div class="extraction-row">
          <label>Element</label>
          <select id="extractedElement">
            <option value="None">None</option>
            <option value="Fire">Fire</option>
            <option value="Poison">Poison</option>
            <option value="Lightning">Lightning</option>
            <option value="Ice">Ice</option>
            <option value="Dark">Dark</option>
            <option value="Holy">Holy</option>
          </select>
          <span class="confidence" id="elementConfidence"></span>
        </div>
        <div class="extraction-row">
          <label>Type</label>
          <select id="extractedType">
            <option value="Human">Human</option>
            <option value="Beast">Beast</option>
            <option value="Plant">Plant</option>
            <option value="Aquatic">Aquatic</option>
            <option value="Fairy">Fairy</option>
            <option value="Reptile">Reptile</option>
            <option value="Devil">Devil</option>
            <option value="Undead">Undead</option>
            <option value="Machine">Machine</option>
          </select>
          <span class="confidence" id="typeConfidence"></span>
        </div>
        <div class="extraction-row extraction-row-text">
          <label>Conditional Text</label>
          <div id="extractedConditionalText" class="extracted-text"></div>
        </div>
        <div class="extraction-row">
          <label>Match</label>
          <select id="extractedConditionalMatch">
            <option value="">-- No match found --</option>
          </select>
          <span class="confidence" id="conditionalConfidence"></span>
        </div>
        <div class="extraction-row">
          <label>Bonus</label>
          <span id="extractedBonusValues" class="bonus-values"></span>
        </div>
      </div>

      <div class="modal-actions">
        <button class="add-btn" data-action="add-from-scan">Add to Roster</button>
        <button class="secondary-btn" data-action="fill-form">Fill Form</button>
        <button class="cancel-btn" data-action="close-modal">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Familiar Edit Modal -->
  <div id="familiarModal" class="modal" style="display: none;">
    <div class="modal-content familiar-modal">
      <h3 id="familiarModalTitle">Add Familiar</h3>
      <input type="hidden" id="familiarEditSlot">
      <div class="familiar-form">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="familiarEditName" placeholder="Familiar name...">
        </div>
        <div class="form-group">
          <label>Rank</label>
          <div id="familiarEditRankContainer"></div>
        </div>
        <div class="form-group">
          <label>Element</label>
          <div id="familiarEditElementContainer"></div>
        </div>
        <div class="form-group">
          <label>Type</label>
          <div id="familiarEditTypeContainer"></div>
        </div>
      </div>
      <!-- Conditional Bonus Search - Two Step -->
      <div class="modal-conditional-section">
        <div class="conditional-label-row">
          <label>Conditional Bonus</label>
          <label class="prepatch-label"><input type="checkbox" id="modalPrePatch"> Pre-patch</label>
        </div>
        <!-- Step 1: Search for condition trigger -->
        <div class="modal-conditional-search">
          <input type="text" id="modalCondSearch" placeholder="Search condition (e.g. Fire, Beast, dice)...">
        </div>
        <div id="modalCondResults" class="config-results" style="display: none;"></div>
        <!-- Step 2: Select bonus variant (appears after trigger selection) -->
        <div id="bonusVariantSection" class="bonus-variant-section" style="display: none;">
          <div class="bonus-variant-header">
            <span class="variant-trigger-name" id="selectedTriggerName"></span>
            <button class="change-trigger-btn" data-action="clear-trigger">Change</button>
          </div>
          <div class="bonus-variant-pills" id="bonusVariantPills">
            <!-- Pills rendered by JS -->
          </div>
        </div>
        <div id="selectedCondDisplay" class="selected-conditional" style="display: none;"></div>
      </div>
      <div class="modal-actions">
        <button class="cancel-btn" data-action="close-modal">Cancel</button>
        <button class="add-btn" data-action="save-familiar">Save</button>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <span>Built by <strong>Bonta</strong> · EU - Luna</span>
    <a href="https://buymeacoffee.com/bonta" target="_blank" class="coffee-link">Buy me a coffee</a>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script type="module" src="dist/index.js"></script>
</body>
</html>
