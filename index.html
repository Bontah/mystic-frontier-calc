<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mystic Frontier Calculator</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>Mystic Frontier Calculator</h1>

  <!-- Navigation Bar -->
  <nav class="top-nav">
    <button class="nav-btn active" onclick="showPage('calculator')">Calculator</button>
    <button class="nav-btn" onclick="showPage('roster')">My Roster</button>
    <button class="nav-btn" onclick="showPage('info')">Additional Information</button>
  </nav>

  <!-- Calculator Page -->
  <div id="page-calculator" class="page active">
    <!-- Familiars Section -->
    <div class="section">
      <h2>Familiars</h2>
      <div class="monster-row">
        <div class="monster-group">
          <label>Fam. 1 Rank</label>
          <select id="monster1Rank" onchange="onRankChange(1)">
            <option value="Common">Common (d3)</option>
            <option value="Rare">Rare (d4)</option>
            <option value="Epic">Epic (d5)</option>
            <option value="Unique">Unique (d6)</option>
            <option value="Legendary">Legendary (d6)</option>
          </select>
          <label style="margin-top: 10px;">Fam. 1 Element</label>
          <select id="monster1Element" onchange="calculate()">
            <option value="None">None</option>
            <option value="Fire">Fire</option>
            <option value="Poison">Poison</option>
            <option value="Lightning">Lightning</option>
            <option value="Ice">Ice</option>
            <option value="Dark">Dark</option>
            <option value="Holy">Holy</option>
          </select>
          <label style="margin-top: 10px;">Fam. 1 Type</label>
          <select id="monster1Type" onchange="calculate()">
            <option value="Human">Human</option>
            <option value="Beast">Beast</option>
            <option value="Plant">Plant</option>
            <option value="Aquatic">Aquatic</option>
            <option value="Fairy">Fairy</option>
            <option value="Reptile">Reptile</option>
            <option value="Devil">Devil</option>
            <option value="Undead">Undead</option>
            <option value="Machine">Machine</option>
          </select>
        </div>
        <div class="monster-group">
          <label>Fam. 2 Rank</label>
          <select id="monster2Rank" onchange="onRankChange(2)">
            <option value="Common">Common (d3)</option>
            <option value="Rare">Rare (d4)</option>
            <option value="Epic">Epic (d5)</option>
            <option value="Unique">Unique (d6)</option>
            <option value="Legendary">Legendary (d6)</option>
          </select>
          <label style="margin-top: 10px;">Fam. 2 Element</label>
          <select id="monster2Element" onchange="calculate()">
            <option value="None">None</option>
            <option value="Fire">Fire</option>
            <option value="Poison">Poison</option>
            <option value="Lightning">Lightning</option>
            <option value="Ice">Ice</option>
            <option value="Dark">Dark</option>
            <option value="Holy">Holy</option>
          </select>
          <label style="margin-top: 10px;">Fam. 2 Type</label>
          <select id="monster2Type" onchange="calculate()">
            <option value="Human">Human</option>
            <option value="Beast">Beast</option>
            <option value="Plant">Plant</option>
            <option value="Aquatic">Aquatic</option>
            <option value="Fairy">Fairy</option>
            <option value="Reptile">Reptile</option>
            <option value="Devil">Devil</option>
            <option value="Undead">Undead</option>
            <option value="Machine">Machine</option>
          </select>
        </div>
        <div class="monster-group">
          <label>Fam. 3 Rank</label>
          <select id="monster3Rank" onchange="onRankChange(3)">
            <option value="Common">Common (d3)</option>
            <option value="Rare">Rare (d4)</option>
            <option value="Epic">Epic (d5)</option>
            <option value="Unique">Unique (d6)</option>
            <option value="Legendary">Legendary (d6)</option>
          </select>
          <label style="margin-top: 10px;">Fam. 3 Element</label>
          <select id="monster3Element" onchange="calculate()">
            <option value="None">None</option>
            <option value="Fire">Fire</option>
            <option value="Poison">Poison</option>
            <option value="Lightning">Lightning</option>
            <option value="Ice">Ice</option>
            <option value="Dark">Dark</option>
            <option value="Holy">Holy</option>
          </select>
          <label style="margin-top: 10px;">Fam. 3 Type</label>
          <select id="monster3Type" onchange="calculate()">
            <option value="Human">Human</option>
            <option value="Beast">Beast</option>
            <option value="Plant">Plant</option>
            <option value="Aquatic">Aquatic</option>
            <option value="Fairy">Fairy</option>
            <option value="Reptile">Reptile</option>
            <option value="Devil">Devil</option>
            <option value="Undead">Undead</option>
            <option value="Machine">Machine</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Saved Lineups Section -->
    <div class="section">
      <h2>Saved Lineups</h2>
      <div class="lineup-controls">
        <input type="text" id="lineupName" class="lineup-name-input" placeholder="Enter lineup name...">
        <button class="save-lineup-btn" onclick="saveLineup()">Save Current Lineup</button>
      </div>
      <div id="savedLineupsList" class="saved-lineups-list">
        <!-- Populated by JavaScript -->
      </div>
    </div>

    <!-- Conditional Bonuses Section -->
    <div class="section">
      <h2>Conditional Bonuses</h2>
      <div class="config-section-title">Bonus Library</div>
      <div class="config-search">
        <input type="text" id="condBonusSearch" placeholder="Search bonuses..." oninput="searchCondBonuses()">
      </div>
      <div id="condBonusSearchResults" class="config-results" style="display: none;"></div>
      <div class="config-section-title">Active Conditionals</div>
      <div id="conditionalList" class="conditional-list">
        <!-- Populated by JavaScript -->
      </div>

      <div class="add-form" style="display: none">
        <h3>+ Add Custom Conditional Bonus</h3>
        <div class="form-row">
          <div class="form-group wide">
            <label>Name</label>
            <input type="text" id="newCondName" placeholder="e.g. Odd Dice 2 Bonus">
          </div>
          <div class="form-group">
            <label>Flat Bonus</label>
            <input type="number" id="newCondFlat" value="0" step="1">
          </div>
          <div class="form-group">
            <label>Multiplier (e.g. 1.6)</label>
            <input type="number" id="newCondMult" value="1" step="0.1">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group" style="flex: 1; min-width: 100%;">
            <label>Condition (JavaScript)</label>
            <textarea id="newCondCondition" placeholder="e.g. dice[1] % 2 === 1"></textarea>
            <div class="help-text">
              Available variables: <code>dice[0]</code>, <code>dice[1]</code>, <code>dice[2]</code> (values based on rank),
              <code>familiars[0]</code>, <code>familiars[1]</code>, <code>familiars[2]</code> (each has <code>.type</code>, <code>.element</code>, and <code>.rank</code>)
            </div>
            <div class="help-text">
              Examples: <code>dice[0] >= 5</code> Â· <code>familiars[0].type === "Beast"</code> Â· <code>dice.every(d => d % 2 === 0)</code>
            </div>
            <div id="conditionError" class="error-text"></div>
          </div>
        </div>
        <button class="add-btn" onclick="addConditionalBonus()">Add Conditional</button>
      </div>
    </div>

    <!-- Bonus Items Section -->
    <div class="section">
      <h2>Bonus Items</h2>
      <div class="config-section-title">Item Library</div>
      <div class="config-search">
        <input type="text" id="bonusItemSearch" placeholder="Search items..." oninput="searchBonusItems()">
      </div>
      <div id="bonusItemSearchResults" class="config-results" style="display: none;"></div>
      <div class="config-section-title">Active Items</div>
      <div id="bonusItemsList" class="bonus-list">
        <!-- Populated by JavaScript -->
      </div>

      <div class="add-form" style="display: none">
        <h3>+ Add Bonus Item</h3>
        <div class="form-row">
          <div class="form-group wide">
            <label>Name</label>
            <input type="text" id="newItemName" placeholder="e.g. Power Ring">
          </div>
          <div class="form-group">
            <label>Flat Bonus</label>
            <input type="number" id="newItemFlat" value="0" step="1">
          </div>
          <div class="form-group">
            <label>Multiplier (e.g. 1.6)</label>
            <input type="number" id="newItemMult" value="1" step="0.1">
          </div>
        </div>
        <button class="add-btn" onclick="addBonusItem()">Add Item</button>
      </div>
    </div>

    <!-- Difficulty Section -->
    <div class="section">
      <h2>Difficulty</h2>
      <div class="difficulty-input">
        <label for="difficulty" style="margin: 0;">Target to beat:</label>
        <input type="number" id="difficulty" value="50" min="0" onchange="calculate()">
      </div>
    </div>

    <!-- Dice Section -->
    <div class="section">
      <h2>Dice</h2>
      <div class="dice-row">
        <div class="dice-group">
          <label>Dice 1</label>
          <select id="dice1" onchange="calculate()">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
          </select>
        </div>
        <div class="dice-group">
          <label>Dice 2</label>
          <select id="dice2" onchange="calculate()">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
          </select>
        </div>
        <div class="dice-group">
          <label>Dice 3</label>
          <select id="dice3" onchange="calculate()">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Results Section -->
    <div class="results">
      <h2 style="margin-top: 0;">Results</h2>
      <div class="result-breakdown">
        <div class="result-item">
          <div class="label">Total Flat Bonus</div>
          <div class="value" id="flatBonus">+0</div>
        </div>
        <div class="result-item">
          <div class="label">Dice Sum</div>
          <div class="value" id="diceSum">3</div>
        </div>
        <div class="result-item">
          <div class="label">Total Multiplier</div>
          <div class="value" id="totalMult">Ã—1.0</div>
        </div>
        <div class="result-item">
          <div class="label">Before Rounding</div>
          <div class="value" id="beforeRound">3</div>
        </div>
      </div>
      <div class="final-result" id="finalResult">3</div>
      <div class="result-status" id="resultStatus">FAIL</div>
      <div class="difference" id="difference">Failed by 47</div>
      <div id="activeBonusesDisplay" style="margin-top: 15px; font-size: 12px; color: #888;"></div>

      <!-- Reroll Suggestions -->
      <div id="rerollSection" class="reroll-section" style="display: none;">
        <div class="reroll-title">ðŸŽ¯ Reroll Suggestions</div>
        <div id="rerollSuggestions" class="reroll-suggestions">
          <!-- Populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <!-- My Roster Page -->
  <div id="page-roster" class="page">
    <!-- Familiar Roster Section -->
    <div class="section">
      <h2>My Familiar Roster</h2>
      <p class="section-description">Add all the familiars you own. The optimizer will suggest the best lineups from your roster.</p>

      <div class="roster-add-form">
        <div class="roster-inputs">
          <select id="rosterRank" onchange="clearRosterConditional()">
            <option value="Common">Common (d3)</option>
            <option value="Rare">Rare (d4)</option>
            <option value="Epic">Epic (d5)</option>
            <option value="Unique">Unique (d6)</option>
            <option value="Legendary">Legendary (d6)</option>
          </select>
          <select id="rosterElement">
            <option value="None">None</option>
            <option value="Fire">Fire</option>
            <option value="Poison">Poison</option>
            <option value="Lightning">Lightning</option>
            <option value="Ice">Ice</option>
            <option value="Dark">Dark</option>
            <option value="Holy">Holy</option>
          </select>
          <select id="rosterType">
            <option value="Human">Human</option>
            <option value="Beast">Beast</option>
            <option value="Plant">Plant</option>
            <option value="Aquatic">Aquatic</option>
            <option value="Fairy">Fairy</option>
            <option value="Reptile">Reptile</option>
            <option value="Devil">Devil</option>
            <option value="Undead">Undead</option>
            <option value="Machine">Machine</option>
          </select>
          <button id="rosterAddBtn" class="add-btn" onclick="addToRoster()">Add to Roster</button>
          <button id="rosterCancelBtn" class="cancel-btn" onclick="cancelEdit()" style="display: none;">Cancel</button>
        </div>
        <div class="roster-conditional-search">
          <input type="text" id="rosterConditionalSearch" placeholder="Search conditional bonus..." oninput="searchRosterConditional()">
          <div id="rosterConditionalResults" class="config-results" style="display: none;"></div>
          <div id="selectedConditionalDisplay" class="selected-conditional" style="display: none;"></div>
        </div>
      </div>

      <div id="rosterList" class="roster-list"></div>
      <div class="roster-stats">
        <span id="rosterCount">0 familiars in roster</span>
      </div>
    </div>

    <!-- Lineup Optimizer Section -->
    <div class="section">
      <h2>Lineup Optimizer</h2>

      <div class="optimizer-filters">
        <div class="filter-group">
          <label>Expedition Element</label>
          <select id="filterElement">
            <option value="">Any Element</option>
            <option value="Fire">Fire</option>
            <option value="Ice">Ice</option>
            <option value="Lightning">Lightning</option>
            <option value="Poison">Poison</option>
            <option value="Dark">Dark</option>
            <option value="Holy">Holy</option>
            <option value="None">None (Non-elemental)</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Expedition Type</label>
          <select id="filterType">
            <option value="">Any Type</option>
            <option value="Human">Human</option>
            <option value="Beast">Beast</option>
            <option value="Plant">Plant</option>
            <option value="Aquatic">Aquatic</option>
            <option value="Fairy">Fairy</option>
            <option value="Reptile">Reptile</option>
            <option value="Devil">Devil</option>
            <option value="Undead">Undead</option>
            <option value="Machine">Machine</option>
          </select>
        </div>
        <div class="filter-mode">
          <label>
            <input type="checkbox" id="filterRequireMatch">
            Require at least one matching familiar
          </label>
        </div>
      </div>

      <div class="optimizer-help">
        <div class="help-toggle" onclick="toggleOptimizerHelp()">
          How does scoring work? <span class="help-icon">?</span>
        </div>
        <div id="optimizerHelpContent" class="optimizer-help-content" style="display: none;">
          <div class="help-item">
            <strong>Best Overall (Expected Value):</strong>
            <p>Calculates the average score across ALL possible dice roll combinations. This gives the most reliable performance estimate.</p>
          </div>
          <div class="help-item">
            <strong>Best for Low Rolls (1-1-1):</strong>
            <p>Shows which lineup performs best when you roll the minimum on all dice - the worst case scenario.</p>
          </div>
          <div class="help-item">
            <strong>Best for High Rolls (Max):</strong>
            <p>Shows which lineup performs best when you roll the maximum on all dice - the best case scenario.</p>
          </div>
        </div>
      </div>

      <div class="optimizer-controls">
        <button class="optimize-btn" onclick="runOptimizer()">Find Best Lineups</button>
      </div>
      <div id="optimizerResults" class="optimizer-results"></div>
    </div>
  </div>

  <!-- Additional Information Page -->
  <div id="page-info" class="page">
    <div class="section">
      <h2>Additional Information</h2>
      <p class="section-description">Information about how the calculator works and game mechanics.</p>

      <div class="info-block">
        <h3>Familiar Ranks & Dice</h3>
        <ul>
          <li><strong>Common:</strong> d3 (rolls 1-3)</li>
          <li><strong>Rare:</strong> d4 (rolls 1-4)</li>
          <li><strong>Epic:</strong> d5 (rolls 1-5)</li>
          <li><strong>Unique:</strong> d6 (rolls 1-6)</li>
          <li><strong>Legendary:</strong> d6 (rolls 1-6)</li>
        </ul>
      </div>

      <div class="info-block">
        <h3>How Calculation Works</h3>
        <ol>
          <li>Roll dice for each familiar (based on their rank)</li>
          <li>Sum all dice values</li>
          <li>Add flat bonuses from items and active conditionals</li>
          <li>Apply multipliers (if any)</li>
          <li>Round down to get final result</li>
          <li>Compare to difficulty target</li>
        </ol>
      </div>

      <div class="info-block">
        <h3>Conditional Bonuses</h3>
        <p>Conditional bonuses activate based on specific conditions like dice values, familiar types, or elements. Each familiar in your roster can have one conditional bonus attached to them.</p>
      </div>

      <div class="info-block">
        <h3>Possible Rewards</h3>
        <p>Community-compiled list of GMS v265 Mystic Frontier rewards:</p>
        <p><a href="https://pastebin.com/kRbUSbt9" target="_blank" class="external-link">GMS v265 - Mystic Frontier Possible Rewards</a></p>
      </div>

      <div class="info-block credits">
        <h3>Credits</h3>
        <p>Built by <strong>Bonta</strong>, Marksman player on EU - Luna</p>
        <div class="coffee-btn">
          <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="bonta" data-color="#1a1a2e" data-emoji=""  data-font="Cookie" data-text="Buy me a coffee" data-outline-color="#ffffff" data-font-color="#ffffff" data-coffee-color="#FFDD00" ></script>
        </div>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
</body>
</html>
